<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kada Gestion – Simulation ERP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest"></script>
  <style>
    :root { color-scheme: dark; }
    body { font-family: 'Inter', sans-serif; background: #0f172a; }
    .sidebar-link { transition: all .2s ease; }
    .sidebar-link.active, .sidebar-link:hover { background-color: rgba(99, 102, 241, .15); color: #eef2ff; }
    .scroll-area { scrollbar-width: thin; scrollbar-color: #475569 transparent; }
    .scroll-area::-webkit-scrollbar { width: 8px; }
    .scroll-area::-webkit-scrollbar-track { background: transparent; }
    .scroll-area::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 4px; }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="text-slate-100">
  <div id="app" class="min-h-screen"></div>

  <script>
  /* =============================================================================================
     KADA GESTION – Simulation front-only
     ---------------------------------------------------------------------------------------------
     - Une seule page (index.html)
     - Persistance locale via localStorage (clé kada:data)
     - Tailwind via CDN & icônes Lucide
     - Modules simulés : clients, appareils, fournisseurs, catalogues, stock, achats, ventes,
       réparations, transferts internes, créances et paramètres (export/import)
     - Toutes les règles métier décrites dans le brief sont implémentées.
     - Les sections marquées // TODO indiquent des pistes d'amélioration futures.
  ============================================================================================= */

  const STORAGE_KEY = 'kada:data';
  const DEMO_YEAR = 2025;
  const STATIC_AES_KEY = 'KadaDemoKey-2025';
  const SITES = ['Lambanyi', 'Madina', 'Atelier', 'Stock central'];
  const ROLES = ['Manager', 'Staff'];
  const STAFF_ROLES = ['Commercial', 'Technicien'];
  const LANGUAGES = ['fr', 'en'];
  const I18N = {
    fr: {
      'nav.dashboard': 'Dashboard',
      'nav.clients': 'Clients',
      'nav.devices': 'Appareils',
      'nav.suppliers': 'Fournisseurs',
      'nav.catalog': 'Articles & Services',
      'nav.stock': 'Stock & Mouvements',
      'nav.purchases': 'Achats',
      'nav.sales': 'Ventes',
      'nav.workorders': 'Réparations',
      'nav.creances': 'Créances',
      'nav.settings': 'Paramètres',
      'header.site': 'Boutique',
      'header.role': 'Rôle',
      'header.subrole': 'Profil staff',
      'header.language': 'Langue',
      'title.dashboard': 'Dashboard',
      'title.clients': 'Clients',
      'title.devices': 'Appareils',
      'title.suppliers': 'Fournisseurs',
      'title.catalog': 'Articles & Services',
      'title.stock': 'Stock & Mouvements',
      'title.purchases': 'Achats',
      'title.sales': 'Ventes',
      'title.workorders': 'Réparations',
      'title.creances': 'Créances',
      'title.settings': 'Paramètres',
      'subtitle.dashboard': 'Vue synthétique des opérations',
      'subtitle.clients': 'Gestion des clients & appareils',
      'subtitle.devices': 'Suivi des appareils confiés',
      'subtitle.suppliers': 'Achats & dettes fournisseurs',
      'subtitle.catalog': 'Catalogue produits et services',
      'subtitle.stock': 'Multi-sites & transferts',
      'subtitle.purchases': 'Factures fournisseurs',
      'subtitle.sales': 'Point de vente & factures clients',
      'subtitle.workorders': 'Workflow complet des bons de réparation',
      'subtitle.creances': 'Suivi des soldes clients & fournisseurs',
      'subtitle.settings': 'Export / import / diagnostics',
      'lang.fr': 'Français',
      'lang.en': 'Anglais',
      'role.manager': 'Manager',
      'role.staff': 'Staff',
      'role.staff.commercial': 'Commercial',
      'role.staff.technicien': 'Technicien',
      'creances.tab.clients': 'Créances clients',
      'creances.tab.suppliers': 'Dettes fournisseurs',
      'creances.filter.site': 'Boutique',
      'creances.status.all': 'Toutes',
      'creances.status.closed': 'Soldées',
      'creances.status.partial': 'Partielles',
      'creances.status.late': 'En retard',
      'creances.status.soon10': 'Échéance ≤ 10 j',
      'creances.summary.clients': 'créance(s) client',
      'creances.summary.suppliers': 'dette(s) fournisseur',
      'creances.summary.total': 'Total restant',
      'creances.table.libelle': 'Libellé',
      'creances.table.site': 'Site',
      'creances.table.montant': 'Montant',
      'creances.table.reste': 'Reste',
      'creances.table.echeance': 'Échéance',
      'creances.table.statut': 'Statut',
      'creances.table.actions': 'Actions',
      'creances.badge.open': 'Ouverte',
      'creances.badge.closed': 'Soldée',
      'creances.badge.partial': 'Partielle',
      'creances.badge.late': 'En retard',
      'creances.badge.soon': 'Échéance proche',
      'creances.empty': 'Aucune créance sur ce filtre.',
      'creances.action.pay': 'Régler'
    },
    en: {
      'nav.dashboard': 'Dashboard',
      'nav.clients': 'Customers',
      'nav.devices': 'Devices',
      'nav.suppliers': 'Suppliers',
      'nav.catalog': 'Catalog',
      'nav.stock': 'Stock & Movements',
      'nav.purchases': 'Purchases',
      'nav.sales': 'Sales',
      'nav.workorders': 'Repairs',
      'nav.creances': 'Receivables',
      'nav.settings': 'Settings',
      'header.site': 'Store',
      'header.role': 'Role',
      'header.subrole': 'Staff profile',
      'header.language': 'Language',
      'title.dashboard': 'Dashboard',
      'title.clients': 'Customers',
      'title.devices': 'Devices',
      'title.suppliers': 'Suppliers',
      'title.catalog': 'Catalog',
      'title.stock': 'Stock & Movements',
      'title.purchases': 'Purchases',
      'title.sales': 'Sales',
      'title.workorders': 'Repairs',
      'title.creances': 'Receivables',
      'title.settings': 'Settings',
      'subtitle.dashboard': 'Synthetic view of operations',
      'subtitle.clients': 'Manage customers & devices',
      'subtitle.devices': 'Track entrusted devices',
      'subtitle.suppliers': 'Supplier invoices & payables',
      'subtitle.catalog': 'Products and services catalog',
      'subtitle.stock': 'Multi-site stock & transfers',
      'subtitle.purchases': 'Supplier bills',
      'subtitle.sales': 'POS & customer invoices',
      'subtitle.workorders': 'Complete repair workflow',
      'subtitle.creances': 'Track customer & supplier balances',
      'subtitle.settings': 'Export / import / diagnostics',
      'lang.fr': 'French',
      'lang.en': 'English',
      'role.manager': 'Manager',
      'role.staff': 'Staff',
      'role.staff.commercial': 'Sales clerk',
      'role.staff.technicien': 'Technician',
      'creances.tab.clients': 'Customer receivables',
      'creances.tab.suppliers': 'Supplier payables',
      'creances.filter.site': 'Store',
      'creances.status.all': 'All',
      'creances.status.closed': 'Settled',
      'creances.status.partial': 'Partial',
      'creances.status.late': 'Overdue',
      'creances.status.soon10': 'Due ≤ 10 days',
      'creances.summary.clients': 'customer balance(s)',
      'creances.summary.suppliers': 'supplier payable(s)',
      'creances.summary.total': 'Outstanding total',
      'creances.table.libelle': 'Label',
      'creances.table.site': 'Site',
      'creances.table.montant': 'Amount',
      'creances.table.reste': 'Remaining',
      'creances.table.echeance': 'Due date',
      'creances.table.statut': 'Status',
      'creances.table.actions': 'Actions',
      'creances.badge.open': 'Open',
      'creances.badge.closed': 'Settled',
      'creances.badge.partial': 'Partial',
      'creances.badge.late': 'Overdue',
      'creances.badge.soon': 'Due soon',
      'creances.empty': 'No balances for this filter.',
      'creances.action.pay': 'Record payment'
    }
  };
  const SYMPTOM_PRESETS = [
    { value: 'ecran_fissure', label: 'Écran fissuré / Cracked screen' },
    { value: 'charge_hs', label: 'Charge HS / Charging issue' },
    { value: 'haut_parleur', label: 'Haut-parleur faible / Speaker low' },
    { value: 'micro_hs', label: 'Micro HS / Microphone issue' },
    { value: 'face_id', label: 'Face ID / Biométrie inopérante' },
    { value: 'batterie_faible', label: 'Autonomie faible / Battery low' }
  ];

  const seedData = {
    version: '1.0.0',
    role: 'Manager',
    staffRole: 'Commercial',
    language: 'fr',
    currentSite: 'Lambanyi',
    clients: [],
    devices: [],
    suppliers: [],
    items: [
      {
        item_id: 'P-0001',
        type: 'product',
        categorie_article: 'Pièce',
        marque: 'Apple',
        modele: 'iPhone 13',
        nom: 'Écran OLED iPhone 13',
        description: 'Écran qualité OEM/Origine',
        prix_achat: 950000,
        prix_vente: 1250000,
        tva: 0,
        sku: 'SCR-IP13-OLED',
        garantie_mois: 6,
        actif: true,
        date_ajout: '2025-09-30'
      },
      {
        item_id: 'P-0002',
        type: 'product',
        categorie_article: 'Accessoire',
        marque: 'Générique',
        modele: '-',
        nom: 'Pochette silicone',
        description: 'Coque silicone transparente',
        prix_achat: 30000,
        prix_vente: 70000,
        tva: 0,
        sku: 'CS-TRANS-001',
        garantie_mois: 0,
        actif: true,
        date_ajout: '2025-09-30'
      },
      {
        item_id: 'S-0001',
        type: 'service',
        categorie_service: 'Réparation',
        nom: 'Remplacement écran iPhone 13',
        description: 'Main-d’œuvre hors pièces',
        tarif_service: 250000,
        tva: 0,
        garantie_mois: 3,
        actif: true
      },
      {
        item_id: 'S-0002',
        type: 'service',
        categorie_service: 'Logiciel',
        nom: 'Flash Android',
        description: 'MAJ / restauration système',
        tarif_service: 150000,
        tva: 0,
        garantie_mois: 0,
        actif: true
      }
    ],
    inventory: [
      { item_id: 'P-0001', site: 'Lambanyi', qty: 5, seuil_reappro: 2 },
      { item_id: 'P-0002', site: 'Lambanyi', qty: 20, seuil_reappro: 5 }
    ],
    service_bom: [
      { service_id: 'S-0001', product_id: 'P-0001', qty: 1 }
    ],
    work_orders: [],
    invoices: [],
    purchases: [],
    stock_moves: [],
    internal_invoices: [],
    creances: []
  };

  const CryptoHelper = {
    key: null,
    async init() {
      const enc = new TextEncoder().encode(STATIC_AES_KEY.padEnd(32, '0'));
      this.key = await crypto.subtle.importKey(
        'raw',
        enc,
        { name: 'AES-GCM' },
        false,
        ['encrypt', 'decrypt']
      );
    },
    async encrypt(plainText) {
      if (!plainText) return '';
      const encoder = new TextEncoder();
      const data = encoder.encode(plainText);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const cipherBuffer = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, this.key, data);
      return btoa(String.fromCharCode(...iv) + String.fromCharCode(...new Uint8Array(cipherBuffer)));
    },
    async decrypt(base64) {
      if (!base64) return '';
      const raw = atob(base64);
      const iv = new Uint8Array([...raw.slice(0, 12)].map(c => c.charCodeAt(0)));
      const data = new Uint8Array([...raw.slice(12)].map(c => c.charCodeAt(0)));
      try {
        const plainBuffer = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, this.key, data);
        return new TextDecoder().decode(plainBuffer);
      } catch (err) {
        console.warn('Decrypt failed', err);
        return '';
      }
    }
  };

  const KadaApp = {
    data: null,
    state: {
      view: 'dashboard',
      modal: null,
      searchTerm: '',
      subState: {},
      notification: null
    },

    async init() {
      await CryptoHelper.init();
      this.loadData();
      this.renderShell();
      this.render();
      this.registerGlobalEvents();
    },

    loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        this.data = structuredClone(seedData);
        this.saveData();
      } else {
        try {
          const parsed = JSON.parse(raw);
          this.data = Object.assign(structuredClone(seedData), parsed);
        } catch (err) {
          console.error('Reset storage after parse error', err);
          this.data = structuredClone(seedData);
          this.saveData();
        }
      }
    },

    saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data));
    },

    t(key) {
      const lang = this.data?.language || 'fr';
      return (I18N[lang] && I18N[lang][key]) || (I18N['fr'] && I18N['fr'][key]) || key;
    },

    isManager() {
      return this.data.role === 'Manager';
    },

    getStaffRole() {
      if (this.isManager()) return 'Manager';
      if (!this.data.staffRole) this.data.staffRole = STAFF_ROLES[0];
      return this.data.staffRole;
    },

    canCommercialActions() {
      return this.isManager() || this.getStaffRole() === 'Commercial';
    },

    canTechnicianActions() {
      return this.isManager() || this.getStaffRole() === 'Technicien';
    },

    toggleStaffSelector() {
      const wrapper = document.getElementById('staff-role-wrapper');
      if (!wrapper) return;
      if (this.data.role === 'Staff') {
        wrapper.classList.remove('hidden');
      } else {
        wrapper.classList.add('hidden');
      }
    },

    renderShell() {
      const container = document.getElementById('app');
      container.innerHTML = `
        <div class="flex min-h-screen">
          <aside class="w-72 bg-slate-900 border-r border-slate-800 flex flex-col">
            <div class="p-6 border-b border-slate-800">
              <div class="text-2xl font-semibold text-indigo-400">Kada Gestion</div>
              <p class="text-xs text-slate-400 mt-1">Simulation ERP Retail & Réparation</p>
            </div>
            <nav class="flex-1 overflow-y-auto scroll-area" id="sidebar-nav"></nav>
            <div class="p-4 border-t border-slate-800 text-xs text-slate-500">
              <p>Version démo – données locales.</p>
              <button id="reset-data" class="mt-2 text-indigo-300 hover:text-indigo-200">Réinitialiser la démo</button>
            </div>
          </aside>
          <main class="flex-1 flex flex-col">
            <header class="h-20 border-b border-slate-800 px-8 flex items-center justify-between bg-slate-950/70 backdrop-blur">
              <div>
                <h1 class="text-xl font-semibold" id="view-title">${this.t('title.dashboard')}</h1>
                <p class="text-sm text-slate-400" id="view-subtitle">${this.t('subtitle.dashboard')}</p>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-sm text-slate-300">${this.t('header.site')}</div>
                <select id="site-select" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm">
                  ${SITES.map(site => `<option value="${site}">${site}</option>`).join('')}
                </select>
                <div class="text-sm text-slate-300">${this.t('header.role')}</div>
                <select id="role-select" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm">
                  ${ROLES.map(role => `<option value="${role}">${this.t('role.' + role.toLowerCase())}</option>`).join('')}
                </select>
                <div id="staff-role-wrapper" class="flex items-center gap-2">
                  <div class="text-sm text-slate-300">${this.t('header.subrole')}</div>
                  <select id="staff-role-select" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm">
                    ${STAFF_ROLES.map(role => `<option value="${role}">${this.t('role.staff.' + role.toLowerCase())}</option>`).join('')}
                  </select>
                </div>
                <div class="text-sm text-slate-300">${this.t('header.language')}</div>
                <select id="language-select" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm">
                  ${LANGUAGES.map(lang => `<option value="${lang}">${this.t('lang.' + lang)}</option>`).join('')}
                </select>
              </div>
            </header>
            <section class="flex-1 overflow-y-auto scroll-area" id="view-container"></section>
          </main>
        </div>
        <div id="modal-layer"></div>
        <div id="toast-layer" class="fixed bottom-4 right-6 space-y-2"></div>
      `;
      document.getElementById('site-select').value = this.data.currentSite;
      document.getElementById('role-select').value = this.data.role;
      document.getElementById('staff-role-select').value = this.data.staffRole || STAFF_ROLES[0];
      document.getElementById('language-select').value = this.data.language || 'fr';
      document.getElementById('reset-data').addEventListener('click', () => this.resetData());
      this.toggleStaffSelector();
    },

    registerGlobalEvents() {
      document.getElementById('site-select').addEventListener('change', (e) => {
        this.data.currentSite = e.target.value;
        this.saveData();
        this.render();
      });
      document.getElementById('role-select').addEventListener('change', (e) => {
        this.data.role = e.target.value;
        if (this.data.role === 'Staff' && !this.data.staffRole) this.data.staffRole = STAFF_ROLES[0];
        this.saveData();
        this.toggleStaffSelector();
        this.render();
      });
      document.getElementById('staff-role-select').addEventListener('change', (e) => {
        this.data.staffRole = e.target.value;
        this.saveData();
        this.render();
      });
      document.getElementById('language-select').addEventListener('change', (e) => {
        this.data.language = e.target.value;
        this.saveData();
        this.render();
      });
    },

    resetData() {
      if (confirm('Réinitialiser toutes les données ?')) {
        this.data = structuredClone(seedData);
        this.saveData();
        this.render();
        this.showToast('Données réinitialisées.');
      }
    },

    showToast(message, type = 'success') {
      const toastLayer = document.getElementById('toast-layer');
      const id = `toast-${Date.now()}`;
      const colors = {
        success: 'bg-emerald-500/10 border border-emerald-500/40 text-emerald-200',
        warning: 'bg-amber-500/10 border border-amber-500/40 text-amber-200',
        error: 'bg-rose-500/10 border border-rose-500/40 text-rose-200'
      };
      const div = document.createElement('div');
      div.id = id;
      div.className = `px-4 py-3 rounded shadow-lg ${colors[type] || colors.success}`;
      div.textContent = message;
      toastLayer.appendChild(div);
      setTimeout(() => div.remove(), 4000);
    },

    render() {
      this.renderSidebar();
      this.renderView();
      this.renderModal();
      lucide.createIcons();
    },

    renderSidebar() {
      const views = [
        { id: 'dashboard', labelKey: 'nav.dashboard', icon: 'layout-dashboard' },
        { id: 'clients', labelKey: 'nav.clients', icon: 'users' },
        { id: 'devices', labelKey: 'nav.devices', icon: 'smartphone' },
        { id: 'suppliers', labelKey: 'nav.suppliers', icon: 'store' },
        { id: 'catalog', labelKey: 'nav.catalog', icon: 'box' },
        { id: 'stock', labelKey: 'nav.stock', icon: 'boxes' },
        { id: 'purchases', labelKey: 'nav.purchases', icon: 'truck' },
        { id: 'sales', labelKey: 'nav.sales', icon: 'shopping-cart' },
        { id: 'workorders', labelKey: 'nav.workorders', icon: 'wrench' },
        { id: 'creances', labelKey: 'nav.creances', icon: 'files' },
        { id: 'settings', labelKey: 'nav.settings', icon: 'settings' }
      ];
      const nav = document.getElementById('sidebar-nav');
      nav.innerHTML = `
        <ul class="p-4 space-y-1">
          ${views.map(v => `
            <li>
              <button data-view="${v.id}" class="sidebar-link w-full flex items-center gap-3 px-3 py-2 rounded text-sm ${this.state.view === v.id ? 'active' : 'text-slate-400'}">
                <i data-lucide="${v.icon}" class="w-4 h-4"></i>
                <span>${this.t(v.labelKey)}</span>
              </button>
            </li>
          `).join('')}
        </ul>
      `;
      nav.querySelectorAll('button[data-view]').forEach(btn => {
        btn.addEventListener('click', () => {
          this.state.view = btn.dataset.view;
          this.state.searchTerm = '';
          this.state.subState = {};
          this.render();
        });
      });
    },

    renderView() {
      const viewContainer = document.getElementById('view-container');
      const titleMap = {
        dashboard: ['title.dashboard', 'subtitle.dashboard'],
        clients: ['title.clients', 'subtitle.clients'],
        devices: ['title.devices', 'subtitle.devices'],
        suppliers: ['title.suppliers', 'subtitle.suppliers'],
        catalog: ['title.catalog', 'subtitle.catalog'],
        stock: ['title.stock', 'subtitle.stock'],
        purchases: ['title.purchases', 'subtitle.purchases'],
        sales: ['title.sales', 'subtitle.sales'],
        workorders: ['title.workorders', 'subtitle.workorders'],
        creances: ['title.creances', 'subtitle.creances'],
        settings: ['title.settings', 'subtitle.settings']
      };
      const [titleKey, subtitleKey] = titleMap[this.state.view];
      document.getElementById('view-title').textContent = this.t(titleKey);
      document.getElementById('view-subtitle').textContent = this.t(subtitleKey);

      const renderer = {
        dashboard: () => this.renderDashboard(),
        clients: () => this.renderClients(),
        devices: () => this.renderDevices(),
        suppliers: () => this.renderSuppliers(),
        catalog: () => this.renderCatalog(),
        stock: () => this.renderStock(),
        purchases: () => this.renderPurchases(),
        sales: () => this.renderSales(),
        workorders: () => this.renderWorkOrders(),
        creances: () => this.renderCreances(),
        settings: () => this.renderSettings()
      }[this.state.view];

      viewContainer.innerHTML = renderer ? renderer() : '';
      this.bindViewEvents();
    },

    bindViewEvents() {
      switch (this.state.view) {
        case 'clients':
          this.bindClientEvents();
          break;
        case 'devices':
          this.bindDeviceEvents();
          break;
        case 'suppliers':
          this.bindSupplierEvents();
          break;
        case 'catalog':
          this.bindCatalogEvents();
          break;
        case 'stock':
          this.bindStockEvents();
          break;
        case 'purchases':
          this.bindPurchaseEvents();
          break;
        case 'sales':
          this.bindSalesEvents();
          break;
        case 'workorders':
          this.bindWorkOrderEvents();
          break;
        case 'creances':
          this.bindCreanceEvents();
          break;
        case 'settings':
          this.bindSettingsEvents();
          break;
        default:
          break;
      }
    },

    closeModal() {
      this.state.modal = null;
      this.renderModal();
    },

    /* -------------------------------- UTILITAIRES -------------------------------- */
    formatGNF(value) {
      const amount = Number(value || 0);
      return amount.toLocaleString('fr-FR') + ' GNF';
    },

    todayISO() { return new Date().toISOString(); },

    nextId(prefix, collection) {
      const seq = collection.reduce((max, entry) => {
        const val = (entry.id || entry.item_id || entry.invoice_id || entry.wo_id || '').match(/(\d+)$/);
        const num = val ? parseInt(val[1], 10) : 0;
        return num > max ? num : max;
      }, 0);
      return `${prefix}-${String(seq + 1).padStart(4, '0')}`;
    },

    generateSKU(category) {
      const normalize = (value) => (value || 'PROD')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toUpperCase()
        .replace(/[^A-Z0-9]+/g, '_');
      const prefix = normalize(category).split('_').filter(Boolean)[0] || 'PROD';
      const existing = this.data.items
        .filter(item => item.type === 'product' && (item.sku || '').startsWith(`${prefix}-`))
        .reduce((max, item) => {
          const match = (item.sku || '').match(/-(\d+)$/);
          const num = match ? parseInt(match[1], 10) : 0;
          return num > max ? num : max;
        }, 0);
      return `${prefix}-${String(existing + 1).padStart(4, '0')}`;
    },

    nextInvoiceId() {
      const year = DEMO_YEAR;
      const seq = this.data.invoices.reduce((max, inv) => {
        const match = inv.id.match(/FAC-${year}-(\d+)/);
        if (match) {
          const num = parseInt(match[1], 10);
          return num > max ? num : max;
        }
        return max;
      }, 0);
      return `FAC-${year}-${String(seq + 1).padStart(4, '0')}`;
    },

    nextWOId() {
      const seq = this.data.work_orders.reduce((max, wo) => {
        const match = wo.id.match(/WO-(\d+)/);
        if (match) {
          const num = parseInt(match[1], 10);
          return num > max ? num : max;
        }
        return max;
      }, 0);
      return `WO-${String(seq + 1).padStart(4, '0')}`;
    },

    findItem(id) {
      return this.data.items.find(i => i.item_id === id);
    },

    getInventory(itemId, site) {
      return this.data.inventory.find(l => l.item_id === itemId && l.site === site);
    },

    ensureInventory(itemId, site) {
      let entry = this.getInventory(itemId, site);
      if (!entry) {
        entry = { item_id: itemId, site, qty: 0, seuil_reappro: 0 };
        this.data.inventory.push(entry);
      }
      return entry;
    },

    addCreance(creance) {
      if (!Array.isArray(creance.paiements)) creance.paiements = [];
      if (!creance.site) creance.site = this.data.currentSite;
      this.data.creances.push(creance);
    },

    updateCreanceBalance(creanceId) {
      const creance = this.data.creances.find(c => c.id === creanceId);
      if (!creance) return;
      const totalPayes = creance.paiements.reduce((sum, p) => sum + Number(p.montant || 0), 0);
      creance.reste = creance.montant - totalPayes;
      creance.statut = creance.reste <= 0 ? 'solde' : (totalPayes > 0 ? 'partiel' : 'ouvert');
      if (creance.reste <= 0) creance.reste = 0;
    },

    registerInvoicePayment(invoice, paiement) {
      invoice.payes.push(paiement);
      const totalPayes = invoice.payes.reduce((sum, p) => sum + Number(p.montant || 0), 0);
      invoice.reste = Math.max(0, invoice.total - totalPayes);
      invoice.statut = invoice.reste === 0 ? 'payee' : (totalPayes > 0 ? 'partielle' : 'non_payee');
      if (invoice.reste <= 0) invoice.echeance = null;
      if (invoice.creance_id) this.updateCreanceBalance(invoice.creance_id);
    },

    recordStockMove(move) {
      this.data.stock_moves.push(move);
      if (move.type === 'Entree' || move.type === 'Stock initial') {
        const entry = this.ensureInventory(move.item_id, move.site_to || move.site);
        entry.qty += Number(move.qty || 0);
      } else if (move.type === 'Sortie') {
        const entry = this.ensureInventory(move.item_id, move.site_from || move.site);
        entry.qty -= Number(move.qty || 0);
      } else if (move.type === 'Transfert') {
        const source = this.ensureInventory(move.item_id, move.site_from);
        const target = this.ensureInventory(move.item_id, move.site_to);
        source.qty -= move.qty;
        target.qty += move.qty;
      } else if (move.type === 'Réajustement') {
        const entry = this.ensureInventory(move.item_id, move.site);
        entry.qty += Number(move.qty || 0);
      }
    },

    decrementStockForInvoice(invoice) {
      invoice.lignes.filter(l => l.type === 'product').forEach(line => {
        const entry = this.ensureInventory(line.item_id, invoice.site);
        entry.qty -= line.qty;
        this.data.stock_moves.push({
          id: this.nextId('SM', this.data.stock_moves),
          type: 'Sortie',
          item_id: line.item_id,
          site_from: invoice.site,
          qty: line.qty,
          date: invoice.created_at,
          motif: `Décrément facture ${invoice.id}`,
          invoice_id: invoice.id
        });
      });
    },

    bomForService(serviceId) {
      return this.data.service_bom.filter(b => b.service_id === serviceId);
    },

    totalizeLines(lines) {
      return lines.reduce((sum, line) => sum + Number(line.qty || 1) * Number(line.pu || line.prix || 0), 0);
    },

    setSubtitle(view, text) {
      if (this.state.view === view) {
        document.getElementById('view-subtitle').textContent = text;
      }
    },

    /* ------------------------------ DASHBOARD ------------------------------ */
    renderDashboard() {
      const today = new Date().toISOString().slice(0, 10);
      const invoicesToday = this.data.invoices.filter(inv => inv.created_at && inv.created_at.startsWith(today));
      const revenueToday = invoicesToday.reduce((sum, inv) => sum + (inv.type !== 'interne' ? inv.total : 0), 0);
      const salesToday = invoicesToday.filter(inv => inv.type === 'vente').length;
      const openWOs = this.data.work_orders.filter(wo => !['livre', 'rejete'].includes(wo.statut)).length;
      const alerts = this.data.inventory.filter(l => l.qty <= l.seuil_reappro);
      const receivables = this.data.creances.filter(c => c.categorie === 'client').reduce((sum, c) => sum + c.reste, 0);
      const topProducts = this.computeTopProducts();
      return `
        <div class="p-8 space-y-8">
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
            ${[
              { label: 'Chiffre du jour', value: this.formatGNF(revenueToday), icon: 'credit-card' },
              { label: 'Ventes du jour', value: salesToday, icon: 'shopping-bag' },
              { label: 'Bons ouverts', value: openWOs, icon: 'wrench' },
              { label: 'Créances clients', value: this.formatGNF(receivables), icon: 'file-text' }
            ].map(card => `
              <div class="bg-slate-900/80 border border-slate-800 rounded-xl p-6 shadow">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-slate-400 text-sm">${card.label}</p>
                    <p class="text-2xl font-semibold mt-2">${card.value}</p>
                  </div>
                  <div class="p-3 rounded-full bg-indigo-500/10 text-indigo-300">
                    <i data-lucide="${card.icon}" class="w-6 h-6"></i>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>

          <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-6">
              <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold">Alertes stock</h2>
                <span class="text-sm text-slate-400">${alerts.length} article(s)</span>
              </div>
              <div class="mt-4 space-y-3">
                ${alerts.length === 0 ? '<p class="text-sm text-slate-400">Aucune alerte.</p>' : alerts.map(alert => {
                  const item = this.findItem(alert.item_id);
                  return `<div class="flex justify-between text-sm bg-slate-800/50 px-4 py-3 rounded">
                    <div>
                      <p class="font-medium">${item?.nom || alert.item_id}</p>
                      <p class="text-slate-400">${alert.site}</p>
                    </div>
                    <div class="text-right">
                      <p class="text-amber-300">Stock ${alert.qty}</p>
                      <p class="text-slate-500">Seuil ${alert.seuil_reappro}</p>
                    </div>
                  </div>`;
                }).join('')}
              </div>
            </div>
            <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-6">
              <h2 class="text-lg font-semibold">Top produits (ventes)</h2>
              <div class="mt-4 space-y-3">
                ${topProducts.length === 0 ? '<p class="text-sm text-slate-400">Aucune vente encore.</p>' : topProducts.map((prod, idx) => `
                  <div class="flex justify-between items-center bg-slate-800/40 px-4 py-3 rounded">
                    <div class="flex items-center gap-3">
                      <span class="w-8 h-8 rounded-full bg-indigo-500/10 text-indigo-300 flex items-center justify-center">${idx + 1}</span>
                      <div>
                        <p class="font-medium">${prod.nom}</p>
                        <p class="text-xs text-slate-400">${prod.qty} vendu(s)</p>
                      </div>
                    </div>
                    <p class="font-semibold">${this.formatGNF(prod.montant)}</p>
                  </div>`).join('')}
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-6">
              <h2 class="text-lg font-semibold mb-4">Créances proches (< 10 jours)</h2>
              <div class="space-y-3">
                ${this.data.creances.filter(c => c.reste > 0).filter(c => {
                  if (!c.echeance) return false;
                  const diff = (new Date(c.echeance) - new Date()) / (1000*60*60*24);
                  return diff <= 10;
                }).slice(0,5).map(creance => `
                  <div class="bg-slate-800/40 px-4 py-3 rounded text-sm flex justify-between">
                    <div>
                      <p class="font-medium">${creance.libelle}</p>
                      <p class="text-slate-400">Échéance ${creance.echeance}</p>
                    </div>
                    <p class="font-semibold text-amber-300">${this.formatGNF(creance.reste)}</p>
                  </div>
                `).join('') || '<p class="text-sm text-slate-400">Rien à signaler.</p>'}
              </div>
            </div>
            <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-6">
              <h2 class="text-lg font-semibold mb-4">Work Orders actifs</h2>
              <div class="space-y-2">
                ${this.data.work_orders.filter(wo => !['livre', 'rejete'].includes(wo.statut)).slice(0,6).map(wo => {
                  const client = this.data.clients.find(c => c.id === wo.client_id);
                  const device = this.data.devices.find(d => d.id === wo.device_id);
                  return `<div class="bg-slate-800/40 px-4 py-3 rounded text-sm flex justify-between">
                    <div>
                      <p class="font-semibold">${wo.id} – ${client?.nom || 'Client ?'}</p>
                      <p class="text-slate-400">${device?.marque || ''} ${device?.modele || ''}</p>
                    </div>
                    <span class="text-xs px-3 py-1 rounded-full bg-indigo-500/20 text-indigo-200 uppercase">${wo.statut.replace(/_/g,' ')}</span>
                  </div>`;
                }).join('') || '<p class="text-sm text-slate-400">Aucun bon ouvert.</p>'}
              </div>
            </div>
          </div>
        </div>
      `;
    },

    computeTopProducts() {
      const map = new Map();
      this.data.invoices.filter(inv => inv.type !== 'interne').forEach(inv => {
        inv.lignes.filter(line => line.type === 'product').forEach(line => {
          const item = this.findItem(line.item_id);
          if (!item) return;
          const key = line.item_id;
          if (!map.has(key)) map.set(key, { nom: item.nom, qty: 0, montant: 0 });
          const entry = map.get(key);
          entry.qty += line.qty;
          entry.montant += line.qty * line.pu;
        });
      });
      return Array.from(map.values()).sort((a,b) => b.qty - a.qty).slice(0,5);
    },

    /* ------------------------------ CLIENTS ------------------------------ */
    renderClients() {
      const rows = this.data.clients.filter(client => {
        if (!this.state.searchTerm) return true;
        const term = this.state.searchTerm.toLowerCase();
        const devices = this.data.devices.filter(d => d.client_id === client.id);
        const imeis = devices.map(d => d.imei || '').join(' ');
        return [client.id, client.nom, client.whatsapp, imeis].some(val => (val || '').toLowerCase().includes(term));
      });
      return `
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="relative">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                <input id="client-search" type="text" placeholder="Rechercher nom, WhatsApp, ID, IMEI" value="${this.state.searchTerm}" class="bg-slate-900 border border-slate-700 rounded pl-9 pr-4 py-2 text-sm focus:outline-none focus:border-indigo-500" />
              </div>
              <span class="text-xs text-slate-500">${rows.length} client(s)</span>
            </div>
            ${this.canCommercialActions() ? `<button class="btn-primary" data-open="new-client"><i data-lucide="user-plus" class="w-4 h-4"></i> Nouveau client</button>` : ''}
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-5">
            ${rows.map(client => {
              const ardoise = this.data.creances.filter(c => c.categorie === 'client' && c.reference_id === client.id).reduce((sum, c) => sum + c.reste, 0);
              const devices = this.data.devices.filter(d => d.client_id === client.id);
              return `<div class="bg-slate-900/70 border border-slate-800 rounded-xl p-5 space-y-4">
                <div class="flex items-start justify-between">
                  <div>
                    <p class="text-sm text-slate-500">${client.id}</p>
                    <h3 class="text-lg font-semibold">${client.nom}</h3>
                  </div>
                  ${this.canCommercialActions() ? `<button class="text-xs text-indigo-300" data-open-device="${client.id}">+ Appareil</button>` : ''}
                </div>
                <div class="text-sm space-y-1 text-slate-300">
                  <p><span class="text-slate-400">WhatsApp:</span> ${client.whatsapp || '—'}</p>
                  <p><span class="text-slate-400">Ville:</span> ${client.ville || '—'}</p>
                  <p><span class="text-slate-400">Adresse:</span> ${client.adresse || '—'}</p>
                </div>
                <div class="text-xs text-slate-400 bg-slate-800/50 rounded px-3 py-2">
                  ${client.notes || 'Aucune note.'}
                </div>
                <div class="flex items-center justify-between text-sm">
                  <div>${devices.length} appareil(s)</div>
                  <div class="text-amber-300">Ardoise: ${this.formatGNF(ardoise)}</div>
                </div>
                <button class="w-full text-sm bg-slate-800/50 hover:bg-slate-800 rounded px-3 py-2" data-client-detail="${client.id}">Voir fiche</button>
              </div>`;
            }).join('') || '<p class="text-sm text-slate-400">Ajoutez votre premier client.</p>'}
          </div>
        </div>
      `;
    },

    bindClientEvents() {
      const search = document.getElementById('client-search');
      if (search) {
        search.addEventListener('input', (e) => {
          this.state.searchTerm = e.target.value;
          this.render();
        });
      }
      document.querySelectorAll('[data-open="new-client"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-client')));
      document.querySelectorAll('[data-open-device]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-device', { client_id: btn.dataset.openDevice })));
      document.querySelectorAll('[data-client-detail]').forEach(btn => btn.addEventListener('click', () => {
        this.state.subState.selectedClient = btn.dataset.clientDetail;
        this.renderClientDetail();
      }));
    },

    renderClientDetail() {
      const clientId = this.state.subState.selectedClient;
      if (!clientId) return;
      const client = this.data.clients.find(c => c.id === clientId);
      if (!client) return;
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50';
      const ardoise = this.data.creances.filter(c => c.categorie === 'client' && c.reference_id === client.id);
      const invoices = this.data.invoices.filter(inv => inv.client_id === client.id);
      const devices = this.data.devices.filter(dev => dev.client_id === client.id);
      modal.innerHTML = `
        <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
          <div class="flex justify-between items-center px-6 py-4 border-b border-slate-800">
            <div>
              <p class="text-xs text-slate-500">${client.id}</p>
              <h2 class="text-xl font-semibold">${client.nom}</h2>
            </div>
            <button class="text-slate-400 hover:text-slate-200" id="close-client-detail"><i data-lucide="x" class="w-5 h-5"></i></button>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 px-6 py-5 overflow-y-auto scroll-area">
            <section class="lg:col-span-1 space-y-4">
              <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-4 text-sm space-y-2">
                <p><span class="text-slate-400">WhatsApp:</span> ${client.whatsapp || '—'}</p>
                <p><span class="text-slate-400">Ville:</span> ${client.ville || '—'}</p>
                <p><span class="text-slate-400">Adresse:</span> ${client.adresse || '—'}</p>
                <p><span class="text-slate-400">Notes:</span> ${client.notes || '—'}</p>
              </div>
              <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-4">
                <h3 class="text-sm font-semibold mb-3">Ardoise</h3>
                <p class="text-amber-300 text-lg font-semibold">${this.formatGNF(ardoise.reduce((sum,c)=>sum+c.reste,0))}</p>
                <div class="mt-4 space-y-2 text-xs text-slate-400 max-h-40 overflow-y-auto">
                  ${ardoise.map(c => `<div class="bg-slate-800/40 rounded px-3 py-2">
                    <p class="font-medium text-slate-200">${c.libelle}</p>
                    <p>Reste: ${this.formatGNF(c.reste)} – Échéance: ${c.echeance || '—'}</p>
                  </div>`).join('') || '<p>Aucune créance.</p>'}
                </div>
              </div>
            </section>
            <section class="lg:col-span-2 space-y-6">
              <div>
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-semibold uppercase tracking-wider text-slate-400">Appareils</h3>
                  ${this.canCommercialActions() ? `<button class="text-xs text-indigo-300" data-open-device="${client.id}">+ Ajouter</button>` : ''}
                </div>
                <div class="space-y-3">
                  ${devices.map(dev => `<div class="bg-slate-900/70 border border-slate-800 rounded-lg p-4 text-sm flex justify-between">
                    <div>
                      <p class="font-semibold">${dev.marque} ${dev.modele}</p>
                      <p class="text-slate-400">IMEI: ${dev.imei || '—'} ${dev.imei_provisoire ? '(provisoire)' : ''}</p>
                      <p class="text-slate-500">Créé le ${dev.created_at?.split('T')[0] || ''}</p>
                    </div>
                    <div class="text-right text-xs text-slate-400">
                      <p>Code verrouillage: ${dev.code_deverrouillage ? '********' : '—'}</p>
                    </div>
                  </div>`).join('') || '<p class="text-sm text-slate-400">Aucun appareil enregistré.</p>'}
                </div>
              </div>
              <div>
                <h3 class="text-sm font-semibold uppercase tracking-wider text-slate-400 mb-3">Historique factures</h3>
                <div class="space-y-2 text-sm">
                  ${invoices.map(inv => `<div class="bg-slate-900/50 border border-slate-800 rounded-lg px-4 py-3 flex justify-between">
                    <div>
                      <p class="font-semibold">${inv.id} – ${inv.type}</p>
                      <p class="text-xs text-slate-400">${inv.created_at?.replace('T',' ')}</p>
                    </div>
                    <div class="text-right">
                      <p>${this.formatGNF(inv.total)}</p>
                      <p class="text-xs text-slate-400">Statut ${inv.statut}</p>
                    </div>
                  </div>`).join('') || '<p class="text-sm text-slate-400">Aucune facture.</p>'}
                </div>
              </div>
            </section>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      lucide.createIcons();
      modal.querySelector('#close-client-detail').addEventListener('click', () => {
        modal.remove();
        this.state.subState.selectedClient = null;
      });
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
          this.state.subState.selectedClient = null;
        }
      });
    },

    modalClient() {
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Nouveau client</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-new-client" class="px-6 py-6 space-y-4 text-sm">
              <div>
                <label class="block mb-1 text-slate-400">Nom <span class="text-rose-400">*</span></label>
                <input name="nom" required class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">WhatsApp</label>
                  <input name="whatsapp" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Ville</label>
                  <input name="ville" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Adresse</label>
                <input name="adresse" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Notes</label>
                <textarea name="notes" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2"></textarea>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    createClientRecord(formData) {
      const client = {
        id: this.nextId('CL', this.data.clients),
        nom: formData.nom,
        whatsapp: formData.whatsapp || '',
        ville: formData.ville || '',
        adresse: formData.adresse || '',
        notes: formData.notes || '',
        created_at: this.todayISO()
      };
      this.data.clients.push(client);
      return client;
    },

    async handleNewClient(form) {
      const formData = Object.fromEntries(new FormData(form).entries());
      this.createClientRecord(formData);
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Client ajouté.');
    },

    modalDevice(payload) {
      const clientId = payload?.client_id || '';
      const client = this.data.clients.find(c => c.id === clientId);
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Nouvel appareil</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-new-device" class="px-6 py-6 space-y-4 text-sm">
              <div>
                <label class="block mb-1 text-slate-400">Client <span class="text-rose-400">*</span></label>
                <select name="client_id" required class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                  <option value="">-- Sélectionner --</option>
                  ${this.data.clients.map(c => `<option value="${c.id}" ${c.id === clientId ? 'selected' : ''}>${c.nom}</option>`).join('')}
                </select>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Marque</label>
                  <input name="marque" required class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Modèle</label>
                  <input name="modele" required class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">IMEI (optionnel)</label>
                  <input name="imei" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div class="flex items-center gap-2 mt-6 text-xs text-slate-400">
                  <input type="checkbox" name="imei_provisoire" class="bg-slate-900 border-slate-700" />
                  <span>IMEI provisoire</span>
                </div>
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Code déverrouillage</label>
                <input name="code_deverrouillage" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="PIN / schéma" />
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async createDeviceRecord(formData) {
      const encrypted = formData.code_deverrouillage ? await CryptoHelper.encrypt(formData.code_deverrouillage) : '';
      const device = {
        id: this.nextId('APP', this.data.devices),
        client_id: formData.client_id,
        marque: formData.marque,
        modele: formData.modele,
        imei: formData.imei || '',
        imei_provisoire: formData.imei_provisoire === 'on',
        code_deverrouillage: encrypted,
        created_at: this.todayISO()
      };
      this.data.devices.push(device);
      return device;
    },

    async handleNewDevice(form) {
      const formData = Object.fromEntries(new FormData(form).entries());
      await this.createDeviceRecord(formData);
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Appareil ajouté.');
    },

    /* ------------------------------ APPAREILS ------------------------------ */
    renderDevices() {
      return `
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="relative">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                <input id="device-search" value="${this.state.searchTerm}" placeholder="Rechercher marque, modèle ou IMEI" class="bg-slate-900 border border-slate-700 rounded pl-9 pr-4 py-2 text-sm" />
              </div>
              <span class="text-xs text-slate-500">${this.data.devices.length} appareil(s)</span>
            </div>
            ${this.canCommercialActions() ? `<button class="btn-primary" data-open="new-device"><i data-lucide="smartphone" class="w-4 h-4"></i> Ajouter appareil</button>` : ''}
          </div>
          <div class="overflow-hidden border border-slate-800 rounded-xl">
            <table class="w-full text-sm">
              <thead class="bg-slate-900/80 text-slate-400 uppercase text-xs">
                <tr>
                  <th class="text-left px-4 py-3">Appareil</th>
                  <th class="text-left px-4 py-3">Client</th>
                  <th class="text-left px-4 py-3">IMEI</th>
                  <th class="text-left px-4 py-3">IMEI provisoire</th>
                  <th class="text-left px-4 py-3">Historique réparations</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800">
                ${this.data.devices.filter(dev => {
                  if (!this.state.searchTerm) return true;
                  const term = this.state.searchTerm.toLowerCase();
                  return [dev.marque, dev.modele, dev.imei].some(v => (v || '').toLowerCase().includes(term));
                }).map(dev => {
                  const client = this.data.clients.find(c => c.id === dev.client_id);
                  const repairs = this.data.work_orders.filter(wo => wo.device_id === dev.id);
                  return `<tr class="hover:bg-slate-900/40">
                    <td class="px-4 py-3">
                      <div class="font-medium">${dev.marque} ${dev.modele}</div>
                      <div class="text-xs text-slate-500">${dev.id}</div>
                    </td>
                    <td class="px-4 py-3">${client?.nom || '—'}</td>
                    <td class="px-4 py-3">${dev.imei || '—'}</td>
                    <td class="px-4 py-3">${dev.imei_provisoire ? 'Oui' : 'Non'}</td>
                    <td class="px-4 py-3 text-xs text-slate-400">${repairs.map(r => r.id).join(', ') || 'Aucune réparation'}</td>
                  </tr>`;
                }).join('') || '<tr><td colspan="5" class="px-4 py-4 text-center text-sm text-slate-400">Aucun appareil.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    },

    bindDeviceEvents() {
      const search = document.getElementById('device-search');
      if (search) search.addEventListener('input', (e) => { this.state.searchTerm = e.target.value; this.render(); });
      document.querySelectorAll('[data-open="new-device"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-device')));
    },

    /* ------------------------------ FOURNISSEURS ------------------------------ */
    renderSuppliers() {
      return `
        <div class="p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold">Fournisseurs</h2>
            ${this.canCommercialActions() ? '<button class="btn-primary" data-open="new-supplier"><i data-lucide="store" class="w-4 h-4"></i> Ajouter fournisseur</button>' : ''}
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
            ${this.data.suppliers.map(s => {
              const balance = this.data.creances.filter(c => c.categorie === 'fournisseur' && c.reference_id === s.id).reduce((sum, c) => sum + c.reste, 0);
              return `<div class="bg-slate-900/70 border border-slate-800 rounded-xl p-5 space-y-4">
                <div class="flex items-start justify-between">
                  <div>
                    <p class="text-xs text-slate-500">${s.id}</p>
                    <h3 class="text-lg font-semibold">${s.nom}</h3>
                  </div>
                  <button class="text-xs text-indigo-300" data-supplier-detail="${s.id}">Voir</button>
                </div>
                <p class="text-sm text-slate-400">Contact: ${s.contact || '—'}</p>
                <p class="text-sm text-amber-300">Ardoise: ${this.formatGNF(balance)}</p>
              </div>`;
            }).join('') || '<p class="text-sm text-slate-400">Ajoutez votre premier fournisseur.</p>'}
          </div>
        </div>
      `;
    },

    bindSupplierEvents() {
      document.querySelectorAll('[data-open="new-supplier"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-supplier')));
      document.querySelectorAll('[data-supplier-detail]').forEach(btn => btn.addEventListener('click', () => this.renderSupplierDetail(btn.dataset.supplierDetail)));
    },

    modalSupplier() {
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Nouveau fournisseur</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-new-supplier" class="px-6 py-6 space-y-4 text-sm">
              <div>
                <label class="block mb-1 text-slate-400">Nom <span class="text-rose-400">*</span></label>
                <input name="nom" required class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Contact</label>
                <input name="contact" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handleNewSupplier(form) {
      const formData = Object.fromEntries(new FormData(form).entries());
      const supplier = {
        id: this.nextId('F', this.data.suppliers),
        nom: formData.nom,
        contact: formData.contact || '',
        created_at: this.todayISO()
      };
      this.data.suppliers.push(supplier);
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Fournisseur ajouté.');
    },

    renderSupplierDetail(id) {
      const supplier = this.data.suppliers.find(s => s.id === id);
      if (!supplier) return;
      const purchases = this.data.purchases.filter(p => p.supplier_id === supplier.id);
      const creances = this.data.creances.filter(c => c.categorie === 'fournisseur' && c.reference_id === supplier.id);
      const wrapper = document.createElement('div');
      wrapper.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50';
      wrapper.innerHTML = `
        <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
          <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
            <div>
              <p class="text-xs text-slate-500">${supplier.id}</p>
              <h2 class="text-xl font-semibold">${supplier.nom}</h2>
              <p class="text-sm text-slate-400">${supplier.contact || ''}</p>
            </div>
            <button class="text-slate-400 hover:text-slate-200" id="close-supplier-detail"><i data-lucide="x" class="w-5 h-5"></i></button>
          </div>
          <div class="px-6 py-6 space-y-6 overflow-y-auto scroll-area">
            <section>
              <h3 class="text-sm font-semibold uppercase tracking-wider text-slate-400 mb-3">Factures d'achat</h3>
              <div class="space-y-3 text-sm">
                ${purchases.map(p => `<div class="bg-slate-900/60 border border-slate-800 rounded-lg px-4 py-3 flex justify-between">
                  <div>
                    <p class="font-semibold">${p.id}</p>
                    <p class="text-xs text-slate-400">${p.created_at?.replace('T',' ')}</p>
                  </div>
                  <div class="text-right">
                    <p>${this.formatGNF(p.total)}</p>
                    <p class="text-xs text-slate-400">${p.statut}</p>
                  </div>
                </div>`).join('') || '<p class="text-sm text-slate-400">Aucun achat.</p>'}
              </div>
            </section>
            <section>
              <h3 class="text-sm font-semibold uppercase tracking-wider text-slate-400 mb-3">Ardoise</h3>
              <div class="space-y-3 text-sm">
                ${creances.map(c => `<div class="bg-slate-900/60 border border-slate-800 rounded-lg px-4 py-3 flex justify-between">
                  <div>
                    <p class="font-semibold">${c.libelle}</p>
                    <p class="text-xs text-slate-400">Échéance ${c.echeance || '—'}</p>
                  </div>
                  <div class="text-right">
                    <p>${this.formatGNF(c.reste)}</p>
                    <p class="text-xs text-slate-400">${c.statut}</p>
                  </div>
                </div>`).join('') || '<p class="text-sm text-slate-400">Aucune dette fournisseur.</p>'}
              </div>
            </section>
          </div>
        </div>
      `;
      document.body.appendChild(wrapper);
      lucide.createIcons();
      wrapper.querySelector('#close-supplier-detail').addEventListener('click', () => wrapper.remove());
      wrapper.addEventListener('click', (e) => { if (e.target === wrapper) wrapper.remove(); });
    },

    /* ------------------------------ CATALOGUE ------------------------------ */
    renderCatalog() {
      const products = this.data.items.filter(item => item.type === 'product');
      const services = this.data.items.filter(item => item.type === 'service');
      return `
        <div class="p-8 space-y-8">
          <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold">Produits</h2>
            ${this.canCommercialActions() ? '<button class="btn-primary" data-open="new-product"><i data-lucide="package" class="w-4 h-4"></i> Ajouter produit</button>' : ''}
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
            ${products.map(prod => `<div class="bg-slate-900/70 border border-slate-800 rounded-xl p-5 space-y-3">
              <div class="flex justify-between">
                <div>
                  <p class="text-xs text-slate-500">${prod.item_id}</p>
                  <h3 class="text-lg font-semibold">${prod.nom}</h3>
                  <p class="text-sm text-slate-400">${prod.marque} ${prod.modele}</p>
                </div>
                <span class="text-xs px-3 py-1 rounded-full bg-indigo-500/20 text-indigo-200">${prod.categorie_article}</span>
              </div>
              <p class="text-sm text-slate-400">${prod.description || ''}</p>
              <div class="flex justify-between text-sm">
                <span>Achat: ${this.formatGNF(prod.prix_achat)}</span>
                <span>Vente: ${this.formatGNF(prod.prix_vente)}</span>
              </div>
              <div class="text-xs text-slate-500">SKU ${prod.sku || '—'}</div>
            </div>`).join('') || '<p class="text-sm text-slate-400">Ajoutez un produit.</p>'}
          </div>
          <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold">Services</h2>
            ${this.canCommercialActions() ? '<button class="btn-primary" data-open="new-service"><i data-lucide="badge-check" class="w-4 h-4"></i> Ajouter service</button>' : ''}
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
            ${services.map(serv => `<div class="bg-slate-900/70 border border-slate-800 rounded-xl p-5 space-y-3">
              <div class="flex justify-between">
                <div>
                  <p class="text-xs text-slate-500">${serv.item_id}</p>
                  <h3 class="text-lg font-semibold">${serv.nom}</h3>
                </div>
                <span class="text-xs px-3 py-1 rounded-full bg-indigo-500/20 text-indigo-200">${serv.categorie_service}</span>
              </div>
              <p class="text-sm text-slate-400">${serv.description || ''}</p>
              <div class="text-sm">Tarif: ${this.formatGNF(serv.tarif_service)}</div>
              <div class="text-xs text-slate-500">Garantie ${serv.garantie_mois || 0} mois</div>
            </div>`).join('') || '<p class="text-sm text-slate-400">Ajoutez un service.</p>'}
          </div>
        </div>
      `;
    },

    bindCatalogEvents() {
      document.querySelectorAll('[data-open="new-product"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-product')));
      document.querySelectorAll('[data-open="new-service"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-service')));
    },

    bindNewProductModal() {
      const select = document.getElementById('product-category');
      const preview = document.getElementById('sku-preview');
      if (!select || !preview) return;
      const updatePreview = () => {
        preview.textContent = this.generateSKU(select.value);
      };
      select.addEventListener('change', updatePreview);
    },

    modalProduct() {
      const previewSKU = this.generateSKU('Pièce');
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Nouvel article</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-new-product" class="px-6 py-6 space-y-4 text-sm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Nom <span class="text-rose-400">*</span></label>
                  <input name="nom" required class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Catégorie</label>
                  <select name="categorie_article" id="product-category" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    <option value="Pièce">Pièce</option>
                    <option value="Accessoire">Accessoire</option>
                    <option value="Autre">Autre</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Marque</label>
                  <input name="marque" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Modèle</label>
                  <input name="modele" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div class="bg-slate-900/40 border border-dashed border-slate-700 rounded px-3 py-2 text-xs text-slate-400 flex flex-col justify-center">
                  <span>SKU auto : <span id="sku-preview" class="text-indigo-300 font-semibold">${previewSKU}</span></span>
                  <span>Généré à l'enregistrement.</span>
                </div>
              </div>
              <div class="bg-slate-900/40 border border-slate-800 rounded-lg px-4 py-3 text-xs text-slate-400">
                <p>Les prix d'achat et de vente seront définis via les entrées de stock (stock initial, achats).</p>
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Description</label>
                <textarea name="description" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2"></textarea>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Garantie (mois)</label>
                  <input name="garantie_mois" type="number" value="0" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Seuil réappro</label>
                  <input name="seuil_reappro" type="number" value="0" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handleNewProduct(form) {
      const formData = Object.fromEntries(new FormData(form).entries());
      const category = formData.categorie_article;
      const product = {
        item_id: this.nextId('P', this.data.items.filter(i => i.type === 'product')),
        type: 'product',
        categorie_article: category,
        marque: formData.marque || '',
        modele: formData.modele || '',
        nom: formData.nom,
        description: formData.description || '',
        prix_achat: 0,
        prix_vente: 0,
        tva: 0,
        sku: this.generateSKU(category),
        garantie_mois: Number(formData.garantie_mois || 0),
        actif: true,
        date_ajout: this.todayISO().slice(0,10)
      };
      this.data.items.push(product);
      this.data.inventory.push({ item_id: product.item_id, site: this.data.currentSite, qty: 0, seuil_reappro: Number(formData.seuil_reappro || 0) });
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Article ajouté.');
    },

    modalService() {
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Nouveau service</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-new-service" class="px-6 py-6 space-y-4 text-sm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Nom <span class="text-rose-400">*</span></label>
                  <input name="nom" required class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Catégorie</label>
                  <select name="categorie_service" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    <option value="Réparation">Réparation</option>
                    <option value="Logiciel">Logiciel</option>
                    <option value="Autre">Autre</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Description</label>
                <textarea name="description" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2"></textarea>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Tarif</label>
                  <input name="tarif_service" type="number" min="0" value="0" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Garantie (mois)</label>
                  <input name="garantie_mois" type="number" value="0" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handleNewService(form) {
      const formData = Object.fromEntries(new FormData(form).entries());
      const service = {
        item_id: this.nextId('S', this.data.items.filter(i => i.type === 'service')),
        type: 'service',
        categorie_service: formData.categorie_service,
        nom: formData.nom,
        description: formData.description || '',
        tarif_service: Number(formData.tarif_service || 0),
        tva: 0,
        garantie_mois: Number(formData.garantie_mois || 0),
        actif: true
      };
      this.data.items.push(service);
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Service ajouté.');
    },

    /* ------------------------------ STOCK ------------------------------ */
    renderStock() {
      const grouped = {};
      this.data.inventory.forEach(line => {
        const item = this.findItem(line.item_id);
        if (!item) return;
        if (!grouped[line.site]) grouped[line.site] = [];
        grouped[line.site].push({ line, item });
      });
      return `
        <div class="p-8 space-y-8">
          <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold">État des stocks</h2>
            ${this.canCommercialActions() ? `
            <div class="flex gap-3">
              <button class="btn-secondary" data-open="new-stock-move"><i data-lucide="plus-circle" class="w-4 h-4"></i> Mouvement</button>
              <button class="btn-primary" data-open="new-transfer"><i data-lucide="arrow-right-left" class="w-4 h-4"></i> Transfert</button>
            </div>` : ''}
          </div>
          <div class="space-y-6">
            ${Object.keys(grouped).sort().map(site => `
              <div class="bg-slate-900/70 border border-slate-800 rounded-xl">
                <div class="px-6 py-4 border-b border-slate-800 flex items-center justify-between">
                  <h3 class="text-lg font-semibold">${site}</h3>
                  <span class="text-xs text-slate-400">${grouped[site].length} article(s)</span>
                </div>
                <div class="divide-y divide-slate-800">
                  ${grouped[site].map(({line, item}) => `<div class="px-6 py-4 flex items-center justify-between text-sm">
                    <div>
                      <p class="font-medium">${item.nom}</p>
                      <p class="text-xs text-slate-500">${item.item_id}</p>
                    </div>
                    <div class="text-right">
                      <p class="font-semibold ${line.qty <= line.seuil_reappro ? 'text-amber-300' : ''}">Stock ${line.qty}</p>
                      <p class="text-xs text-slate-500">Seuil ${line.seuil_reappro}</p>
                    </div>
                  </div>`).join('')}
                </div>
              </div>
            `).join('') || '<p class="text-sm text-slate-400">Aucun inventaire encore.</p>'}
          </div>
          <div>
            <h2 class="text-lg font-semibold mb-3">Historique mouvements</h2>
            <div class="bg-slate-900/50 border border-slate-800 rounded-xl overflow-hidden">
              <table class="w-full text-sm">
                <thead class="bg-slate-900/70 text-slate-400 text-xs uppercase">
                  <tr>
                    <th class="px-4 py-3 text-left">Date</th>
                    <th class="px-4 py-3 text-left">Type</th>
                    <th class="px-4 py-3 text-left">Article</th>
                    <th class="px-4 py-3 text-left">Sites</th>
                    <th class="px-4 py-3 text-left">Quantité</th>
                    <th class="px-4 py-3 text-left">Motif</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                  ${this.data.stock_moves.slice().reverse().map(move => {
                    const item = this.findItem(move.item_id);
                    const siteInfo = move.site ? move.site : `${move.site_from || '—'} ${move.site_to ? '→ ' + move.site_to : ''}`;
                    return `<tr class="hover:bg-slate-900/40">
                      <td class="px-4 py-3">${move.date?.replace('T',' ') || ''}</td>
                      <td class="px-4 py-3">${move.type}</td>
                      <td class="px-4 py-3">${item?.nom || move.item_id}</td>
                      <td class="px-4 py-3 text-xs text-slate-400">${siteInfo}</td>
                      <td class="px-4 py-3">${move.qty}</td>
                      <td class="px-4 py-3 text-xs text-slate-400">${move.motif || ''}</td>
                    </tr>`;
                  }).join('') || '<tr><td colspan="6" class="px-4 py-4 text-center text-sm text-slate-400">Aucun mouvement.</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    },

    bindStockEvents() {
      document.querySelectorAll('[data-open="new-stock-move"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-stock-move')));
      document.querySelectorAll('[data-open="new-transfer"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-transfer')));
    },

    bindStockMoveModal() {
      const container = document.getElementById('stock-move-lines');
      const typeSelect = document.getElementById('stock-move-type');
      const addLineBtn = document.getElementById('add-stock-line');
      const noteWrapper = document.getElementById('stock-note-wrapper');
      if (!container || !typeSelect || !addLineBtn) return;

      const buildLine = (mode) => {
        const div = document.createElement('div');
        div.dataset.stockLine = mode;
        if (mode === 'stock_initial') {
          div.className = 'grid grid-cols-1 md:grid-cols-6 gap-3 bg-slate-900/40 border border-slate-800 rounded-lg px-3 py-3';
          div.innerHTML = `
            <select name="item_id" class="md:col-span-2 bg-slate-900 border border-slate-700 rounded px-3 py-2">
              ${this.data.items.filter(i => i.type === 'product').map(item => `<option value="${item.item_id}">${item.nom}</option>`).join('')}
            </select>
            <select name="site" class="bg-slate-900 border border-slate-700 rounded px-3 py-2">
              ${SITES.map(site => `<option value="${site}" ${site === this.data.currentSite ? 'selected' : ''}>${site}</option>`).join('')}
            </select>
            <input name="qty" type="number" min="0" value="0" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Qté" />
            <input name="pa" type="number" min="0" value="0" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Prix achat" />
            <input name="pv" type="number" min="0" value="0" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Prix vente" />
            <button type="button" class="text-xs text-rose-300" data-remove-line>Supprimer</button>
          `;
        } else {
          div.className = 'grid grid-cols-1 md:grid-cols-6 gap-3 bg-slate-900/40 border border-slate-800 rounded-lg px-3 py-3';
          div.innerHTML = `
            <select name="item_id" class="md:col-span-2 bg-slate-900 border border-slate-700 rounded px-3 py-2">
              ${this.data.items.filter(i => i.type === 'product').map(item => `<option value="${item.item_id}">${item.nom}</option>`).join('')}
            </select>
            <select name="site" class="bg-slate-900 border border-slate-700 rounded px-3 py-2">
              ${SITES.map(site => `<option value="${site}" ${site === this.data.currentSite ? 'selected' : ''}>${site}</option>`).join('')}
            </select>
            <input name="qty" type="number" value="0" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Qté (+/-)" />
            <select name="motif" class="bg-slate-900 border border-slate-700 rounded px-3 py-2">
              <option value="defaillant">Défaillant</option>
              <option value="manquant">Manquant</option>
              <option value="autre">Autre</option>
            </select>
            <input name="note" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Note" />
            <button type="button" class="text-xs text-rose-300" data-remove-line>Supprimer</button>
          `;
        }
        container.appendChild(div);
      };

      const refresh = () => {
        container.innerHTML = '';
        const mode = typeSelect.value;
        noteWrapper?.classList.toggle('hidden', mode !== 'reajustement');
        buildLine(mode);
      };

      addLineBtn.addEventListener('click', () => buildLine(typeSelect.value));
      typeSelect.addEventListener('change', () => refresh());
      container.addEventListener('click', (e) => {
        if (e.target.matches('[data-remove-line]')) {
          e.target.closest('[data-stock-line]')?.remove();
          if (!container.querySelector('[data-stock-line]')) buildLine(typeSelect.value);
        }
      });

      refresh();
    },
    modalStockMove() {
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Mouvement stock</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-stock-move" class="px-6 py-6 space-y-4 text-sm">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-1">
                  <label class="block mb-1 text-slate-400">Type <span class="text-rose-400">*</span></label>
                  <select name="mode" id="stock-move-type" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    <option value="stock_initial">Stock initial</option>
                    <option value="reajustement">Réajustement</option>
                  </select>
                </div>
                <div class="md:col-span-2 bg-slate-900/40 border border-slate-800 rounded-lg px-4 py-3 text-xs text-slate-400">
                  <p>Les entrées initiales définissent les prix d'achat/vente. Les réajustements peuvent être positifs ou négatifs et demandent un motif.</p>
                </div>
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Lignes</label>
                <div id="stock-move-lines" class="space-y-3"></div>
                <button type="button" id="add-stock-line" class="text-xs text-indigo-300 mt-2">+ Ajouter une ligne</button>
              </div>
              <div id="stock-note-wrapper" class="hidden">
                <label class="block mb-1 text-slate-400">Commentaire global</label>
                <textarea name="note_generale" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Précisions supplémentaires"></textarea>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Valider</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handleStockMove(form) {
      const formData = new FormData(form);
      const mode = formData.get('mode');
      const lines = Array.from(form.querySelectorAll('[data-stock-line]'));
      if (lines.length === 0) { alert('Ajouter au moins une ligne.'); return; }
      if (mode === 'stock_initial') {
        let processed = false;
        lines.forEach(div => {
          const item_id = div.querySelector('select[name="item_id"]').value;
          const site = div.querySelector('select[name="site"]').value;
          const qty = Number(div.querySelector('input[name="qty"]').value || 0);
          const pa = Number(div.querySelector('input[name="pa"]').value || 0);
          const pv = Number(div.querySelector('input[name="pv"]').value || 0);
          if (!item_id || qty <= 0) return;
          processed = true;
          const move = {
            id: this.nextId('SM', this.data.stock_moves),
            type: 'Stock initial',
            item_id,
            site_to: site,
            qty,
            motif: 'Stock initial',
            date: this.todayISO()
          };
          this.recordStockMove(move);
          const item = this.findItem(item_id);
          if (item) {
            if (pa > 0) item.prix_achat = pa;
            if (pv > 0) item.prix_vente = pv;
          }
        });
        if (!processed) { alert('Quantité invalide.'); return; }
        this.saveData();
        this.closeModal();
        this.render();
        this.showToast('Stock initial enregistré.');
      } else if (mode === 'reajustement') {
        const noteGenerale = formData.get('note_generale') || '';
        let valid = false;
        lines.forEach(div => {
          const item_id = div.querySelector('select[name="item_id"]').value;
          const site = div.querySelector('select[name="site"]').value;
          const qty = Number(div.querySelector('input[name="qty"]').value || 0);
          const motif = div.querySelector('select[name="motif"]').value;
          const note = div.querySelector('input[name="note"]').value || '';
          if (!item_id || qty === 0) return;
          valid = true;
          const move = {
            id: this.nextId('SM', this.data.stock_moves),
            type: 'Réajustement',
            item_id,
            site,
            qty,
            motif: `${motif}${note ? ' - ' + note : ''}${noteGenerale ? ' / ' + noteGenerale : ''}`,
            date: this.todayISO()
          };
          this.recordStockMove(move);
        });
        if (!valid) { alert('Renseigner des quantités positives ou négatives.'); return; }
        this.saveData();
        this.closeModal();
        this.render();
        this.showToast('Réajustement enregistré.');
      }
    },

    modalTransfer() {
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Transfert interne</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-transfer" class="px-6 py-6 space-y-4 text-sm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Site source</label>
                  <select name="site_from" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    ${SITES.map(site => `<option value="${site}">${site}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Site destination</label>
                  <select name="site_to" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    ${SITES.map(site => `<option value="${site}">${site}</option>`).join('')}
                  </select>
                </div>
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Article</label>
                <select name="item_id" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                  ${this.data.items.filter(i => i.type === 'product').map(item => `<option value="${item.item_id}">${item.nom}</option>`).join('')}
                </select>
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Quantité</label>
                <input name="qty" type="number" min="1" value="1" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Motif</label>
                <input name="motif" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Transfert interne" />
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Transférer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handleTransfer(form) {
      const formData = Object.fromEntries(new FormData(form).entries());
      if (formData.site_from === formData.site_to) {
        alert('Sites identiques interdits.');
        return;
      }
      const qty = Number(formData.qty || 0);
      if (qty <= 0) return alert('Quantité invalide');
      const move = {
        id: this.nextId('SM', this.data.stock_moves),
        type: 'Transfert',
        item_id: formData.item_id,
        site_from: formData.site_from,
        site_to: formData.site_to,
        qty,
        motif: formData.motif || 'Transfert interne',
        date: this.todayISO()
      };
      this.recordStockMove(move);
      const item = this.findItem(formData.item_id);
      const total = qty * (item?.prix_vente || 0);
      const invoice = {
        id: this.nextInvoiceId(),
        type: 'interne',
        site: formData.site_from,
        site_to: formData.site_to,
        lignes: [{ item_id: formData.item_id, type: 'product', qty, pu: item?.prix_vente || 0, tva: 0 }],
        total,
        payes: [],
        reste: total,
        statut: 'non_payee',
        created_at: this.todayISO(),
        internal: true
      };
      this.data.invoices.push(invoice);
      this.data.internal_invoices.push(invoice);
      const creanceVendeur = {
        id: this.nextId('CR', this.data.creances),
        categorie: 'interne',
        libelle: `Site ${formData.site_to} doit ${formData.site_from}`,
        montant: total,
        reste: total,
        echeance: null,
        reference_id: `${formData.site_from}->${formData.site_to}`,
        statut: 'ouvert',
        paiements: [],
        type: 'client',
        site: formData.site_from
      };
      this.addCreance(creanceVendeur);
      invoice.creance_id = creanceVendeur.id;
      const creanceAcheteur = {
        id: this.nextId('CR', this.data.creances),
        categorie: 'interne',
        libelle: `Dette interne envers ${formData.site_from}`,
        montant: total,
        reste: total,
        echeance: null,
        reference_id: `${formData.site_to}->${formData.site_from}`,
        statut: 'ouvert',
        paiements: [],
        type: 'fournisseur',
        site: formData.site_to
      };
      this.addCreance(creanceAcheteur);
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Transfert enregistré (facture interne).');
    },

    /* ------------------------------ ACHATS ------------------------------ */
    renderPurchases() {
      return `
        <div class="p-8 space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold">Factures d'achat</h2>
            ${this.canCommercialActions() ? '<button class="btn-primary" data-open="new-purchase"><i data-lucide="file-plus" class="w-4 h-4"></i> Nouvel achat</button>' : ''}
          </div>
          <div class="bg-slate-900/60 border border-slate-800 rounded-xl overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-900/70 text-xs text-slate-400 uppercase">
                <tr>
                  <th class="px-4 py-3 text-left">ID</th>
                  <th class="px-4 py-3 text-left">Fournisseur</th>
                  <th class="px-4 py-3 text-left">Site</th>
                  <th class="px-4 py-3 text-left">Total</th>
                  <th class="px-4 py-3 text-left">Payé</th>
                  <th class="px-4 py-3 text-left">Reste</th>
                  <th class="px-4 py-3 text-left">Statut</th>
                  <th class="px-4 py-3 text-left">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800">
                ${this.data.purchases.slice().reverse().map(pur => {
                  const supplier = this.data.suppliers.find(s => s.id === pur.supplier_id);
                  return `<tr class="hover:bg-slate-900/40">
                    <td class="px-4 py-3">${pur.id}</td>
                    <td class="px-4 py-3">${supplier?.nom || pur.supplier_id}</td>
                    <td class="px-4 py-3">${pur.site}</td>
                    <td class="px-4 py-3">${this.formatGNF(pur.total)}</td>
                    <td class="px-4 py-3">${this.formatGNF(pur.total - pur.reste)}</td>
                    <td class="px-4 py-3">${this.formatGNF(pur.reste)}</td>
                    <td class="px-4 py-3"><span class="text-xs px-3 py-1 rounded-full bg-indigo-500/20 text-indigo-200">${pur.statut}</span></td>
                    <td class="px-4 py-3 space-x-2">
                      ${pur.reste > 0 && this.canCommercialActions() ? `<button class="text-xs text-emerald-300" data-pay-purchase="${pur.id}">Régler</button>` : ''}
                    </td>
                  </tr>`;
                }).join('') || '<tr><td colspan="8" class="px-4 py-4 text-center text-sm text-slate-400">Aucun achat.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    },

    bindPurchaseEvents() {
      document.querySelectorAll('[data-open="new-purchase"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-purchase')));
      document.querySelectorAll('[data-pay-purchase]').forEach(btn => btn.addEventListener('click', () => this.openModal('pay-purchase', btn.dataset.payPurchase)));
    },

    modalPurchase() {
      const supplierOptions = this.data.suppliers.map(s => `<option value="${s.id}">${s.nom}</option>`).join('');
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Nouvelle facture fournisseur</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-new-purchase" class="px-6 py-6 space-y-4 text-sm">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Fournisseur</label>
                  <select name="supplier_id" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" required>
                    <option value="">-- Sélectionner --</option>
                    ${supplierOptions}
                  </select>
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Site</label>
                  <select name="site" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    ${SITES.map(site => `<option value="${site}" ${site === this.data.currentSite ? 'selected' : ''}>${site}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Échéance (si crédit)</label>
                  <input type="date" name="echeance" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
              </div>
              <div>
                <label class="block mb-2 text-slate-400">Lignes</label>
                <div id="purchase-lines" class="space-y-3"></div>
                <button type="button" id="add-purchase-line" class="text-xs text-indigo-300 mt-2">+ Ajouter une ligne</button>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Montant payé (optionnel)</label>
                  <input name="montant_paye" type="number" min="0" value="0" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Moyen paiement</label>
                  <select name="moyen_paiement" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    <option value="cash">Cash</option>
                    <option value="mobile_money">Mobile money</option>
                    <option value="">—</option>
                  </select>
                </div>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Créer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    bindPurchaseModal() {
      const container = document.getElementById('purchase-lines');
      const addLine = () => {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-1 md:grid-cols-4 gap-3';
        div.innerHTML = `
          <select name="item_id" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" required>
            ${this.data.items.filter(i => i.type === 'product').map(item => `<option value="${item.item_id}">${item.nom}</option>`).join('')}
          </select>
          <input name="qty" type="number" min="1" value="1" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" />
          <input name="pa" type="number" min="0" value="0" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Prix achat" />
          <input name="pv" type="number" min="0" value="0" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Prix vente standard" />
        `;
        container.appendChild(div);
      };
      addLine();
      document.getElementById('add-purchase-line').addEventListener('click', () => addLine());
    },

    async handleNewPurchase(form) {
      const formData = new FormData(form);
      const lines = [];
      document.querySelectorAll('#purchase-lines > div').forEach(div => {
        const item_id = div.querySelector('select[name="item_id"]').value;
        const qty = Number(div.querySelector('input[name="qty"]').value || 0);
        const pa = Number(div.querySelector('input[name="pa"]').value || 0);
        const pv = Number(div.querySelector('input[name="pv"]').value || 0);
        if (item_id && qty > 0) lines.push({ item_id, qty, pa, pv });
      });
      if (lines.length === 0) {
        alert('Ajouter au moins une ligne.');
        return;
      }
      const total = lines.reduce((sum, l) => sum + l.qty * l.pa, 0);
      const purchase = {
        id: this.nextId('ACH', this.data.purchases),
        supplier_id: formData.get('supplier_id'),
        site: formData.get('site'),
        lignes: lines,
        total,
        payes: [],
        reste: total,
        echeance: formData.get('echeance') || null,
        statut: 'non_payee',
        created_at: this.todayISO()
      };
      const montant_paye = Number(formData.get('montant_paye') || 0);
      if (montant_paye > 0) {
        purchase.payes.push({ montant: montant_paye, moyen: formData.get('moyen_paiement') || 'cash', date: this.todayISO() });
      }
      purchase.reste = Math.max(0, purchase.total - montant_paye);
      purchase.statut = purchase.reste === 0 ? 'payee' : (montant_paye > 0 ? 'partielle' : 'non_payee');
      lines.forEach(line => {
        const move = {
          id: this.nextId('SM', this.data.stock_moves),
          type: 'Entree',
          item_id: line.item_id,
          site: purchase.site,
          site_to: purchase.site,
          qty: line.qty,
          motif: `Achat ${purchase.id}`,
          date: this.todayISO(),
          invoice_id: purchase.id
        };
        this.recordStockMove(move);
        const item = this.findItem(line.item_id);
        if (item) {
          item.prix_achat = line.pa;
          if (line.pv > 0) item.prix_vente = line.pv;
        }
      });
      if (purchase.reste > 0) {
        if (!purchase.echeance) {
          alert('Échéance obligatoire pour un achat à crédit.');
          return;
        }
        const creance = {
          id: this.nextId('CR', this.data.creances),
          categorie: 'fournisseur',
          reference_id: purchase.supplier_id,
          libelle: `Achat ${purchase.id}`,
          montant: purchase.total,
          reste: purchase.reste,
          echeance: purchase.echeance,
          statut: purchase.statut === 'payee' ? 'solde' : (purchase.statut === 'partielle' ? 'partiel' : 'ouvert'),
          paiements: purchase.payes.slice(),
          type: 'fournisseur',
          site: purchase.site
        };
        this.addCreance(creance);
        purchase.creance_id = creance.id;
      }
      this.data.purchases.push(purchase);
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Achat enregistré.');
    },

    modalPayPurchase(id) {
      const purchase = this.data.purchases.find(p => p.id === id);
      if (!purchase) return '';
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Régler ${purchase.id}</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form data-pay-purchase="${purchase.id}" class="px-6 py-6 space-y-4 text-sm">
              <p>Total ${this.formatGNF(purchase.total)} – Reste ${this.formatGNF(purchase.reste)}</p>
              <div>
                <label class="block mb-1 text-slate-400">Montant</label>
                <input name="montant" type="number" min="0" value="${purchase.reste}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Moyen</label>
                <select name="moyen" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                  <option value="cash">Cash</option>
                  <option value="mobile_money">Mobile money</option>
                </select>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white">Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handlePayPurchase(form) {
      const id = form.dataset.payPurchase;
      const purchase = this.data.purchases.find(p => p.id === id);
      if (!purchase) return;
      const formData = new FormData(form);
      const montant = Number(formData.get('montant') || 0);
      if (montant <= 0) return alert('Montant invalide');
      purchase.payes.push({ montant, moyen: formData.get('moyen'), date: this.todayISO() });
      purchase.reste = Math.max(0, purchase.reste - montant);
      purchase.statut = purchase.reste === 0 ? 'payee' : (purchase.reste < purchase.total ? 'partielle' : 'non_payee');
      if (purchase.creance_id) {
        const creance = this.data.creances.find(c => c.id === purchase.creance_id);
        if (creance) {
          creance.paiements.push({ montant, moyen: formData.get('moyen'), date: this.todayISO() });
          this.updateCreanceBalance(creance.id);
        }
      }
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Paiement enregistré.');
    },

    /* ------------------------------ VENTES ------------------------------ */
    renderSales() {
      return `
        <div class="p-8 space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold">Factures clients</h2>
            ${this.canCommercialActions() ? '<button class="btn-primary" data-open="new-sale"><i data-lucide="receipt" class="w-4 h-4"></i> Nouvelle vente</button>' : ''}
          </div>
          <div class="bg-slate-900/60 border border-slate-800 rounded-xl overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-900/70 text-xs text-slate-400 uppercase">
                <tr>
                  <th class="px-4 py-3 text-left">Facture</th>
                  <th class="px-4 py-3 text-left">Client</th>
                  <th class="px-4 py-3 text-left">Type</th>
                  <th class="px-4 py-3 text-left">Total</th>
                  <th class="px-4 py-3 text-left">Payé</th>
                  <th class="px-4 py-3 text-left">Reste</th>
                  <th class="px-4 py-3 text-left">Statut</th>
                  <th class="px-4 py-3 text-left">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800">
                ${this.data.invoices.filter(inv => inv.type !== 'interne').slice().reverse().map(inv => {
                  const client = this.data.clients.find(c => c.id === inv.client_id);
                  return `<tr class="hover:bg-slate-900/40">
                    <td class="px-4 py-3">${inv.id}</td>
                    <td class="px-4 py-3">${client?.nom || inv.client_id || '—'}</td>
                    <td class="px-4 py-3">${inv.type}</td>
                    <td class="px-4 py-3">${this.formatGNF(inv.total)}</td>
                    <td class="px-4 py-3">${this.formatGNF(inv.total - inv.reste)}</td>
                    <td class="px-4 py-3">${this.formatGNF(inv.reste)}</td>
                    <td class="px-4 py-3"><span class="text-xs px-3 py-1 rounded-full bg-indigo-500/20 text-indigo-200">${inv.statut}</span></td>
                    <td class="px-4 py-3 space-x-2">
                      ${inv.reste > 0 && this.canCommercialActions() ? `<button class="text-xs text-emerald-300" data-pay-invoice="${inv.id}">Régler</button>` : ''}
                    </td>
                  </tr>`;
                }).join('') || '<tr><td colspan="8" class="px-4 py-4 text-center text-sm text-slate-400">Aucune facture.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    },

    bindSalesEvents() {
      document.querySelectorAll('[data-open="new-sale"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-sale')));
      document.querySelectorAll('[data-pay-invoice]').forEach(btn => btn.addEventListener('click', () => this.openModal('pay-invoice', btn.dataset.payInvoice)));
    },

    modalSale() {
      const clientOptions = this.data.clients.map(c => `<option value="${c.id}">${c.nom}</option>`).join('');
      const productOptions = this.data.items.filter(i => i.type === 'product').map(item => `<option value="${item.item_id}">${item.nom}</option>`).join('');
      const serviceOptions = this.data.items.filter(i => i.type === 'service').map(item => `<option value="${item.item_id}">${item.nom}</option>`).join('');
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Nouvelle vente</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-new-sale" class="px-6 py-6 space-y-4 text-sm">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Client <span class="text-rose-400">*</span></label>
                  <select name="client_id" required class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    <option value="">-- Sélectionner --</option>
                    ${clientOptions}
                  </select>
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Type de facture</label>
                  <select name="type" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    <option value="vente">Vente</option>
                    <option value="reparation">Réparation</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Remise (%)</label>
                  <input name="remise" type="number" min="0" value="0" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
              </div>
              <div>
                <label class="block mb-2 text-slate-400">Lignes produits</label>
                <div id="sale-product-lines" class="space-y-3"></div>
                <button type="button" id="add-sale-product" class="text-xs text-indigo-300 mt-2">+ Produit</button>
              </div>
              <div>
                <label class="block mb-2 text-slate-400">Lignes services</label>
                <div id="sale-service-lines" class="space-y-3"></div>
                <button type="button" id="add-sale-service" class="text-xs text-indigo-300 mt-2">+ Service</button>
              </div>
              <div id="sale-low-price-warning" class="hidden bg-amber-500/10 border border-amber-500/40 text-amber-200 px-4 py-3 rounded-lg text-xs">
                Prix inférieur au tarif standard détecté. Validation manager requise avec motif détaillé.
              </div>
              <div id="sale-motif-wrapper" class="hidden">
                <label class="block mb-1 text-slate-400">Motif prix inférieur (manager)</label>
                <textarea name="motif_prix" id="sale-motif-prix" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Justification détaillée"></textarea>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Montant payé</label>
                  <input name="montant_paye" type="number" min="0" value="0" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Moyen</label>
                  <select name="moyen" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    <option value="cash">Cash</option>
                    <option value="mobile_money">Mobile money</option>
                  </select>
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Échéance (si reste)</label>
                  <input name="echeance" type="date" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    bindSaleModal() {
      const productContainer = document.getElementById('sale-product-lines');
      const serviceContainer = document.getElementById('sale-service-lines');
      const warning = document.getElementById('sale-low-price-warning');
      const motifWrapper = document.getElementById('sale-motif-wrapper');
      const motifInput = document.getElementById('sale-motif-prix');

      const evaluatePrices = () => {
        let hasLow = false;
        productContainer.querySelectorAll('[data-sale-line="product"]').forEach(div => {
          const select = div.querySelector('select[name="product_id"]');
          const priceInput = div.querySelector('input[name="prix"]');
          if (!select?.value) return;
          const item = this.findItem(select.value);
          const base = item?.prix_vente || 0;
          const current = Number(priceInput.value || 0);
          if (base > 0 && current > 0 && current < base) hasLow = true;
        });
        serviceContainer.querySelectorAll('[data-sale-line="service"]').forEach(div => {
          const select = div.querySelector('select[name="service_id"]');
          const priceInput = div.querySelector('input[name="prix"]');
          if (!select?.value) return;
          const item = this.findItem(select.value);
          const base = item?.tarif_service || 0;
          const current = Number(priceInput.value || 0);
          if (base > 0 && current > 0 && current < base) hasLow = true;
        });
        if (hasLow) {
          warning?.classList.remove('hidden');
          motifWrapper?.classList.remove('hidden');
        } else {
          warning?.classList.add('hidden');
          motifWrapper?.classList.add('hidden');
          if (motifInput) motifInput.value = '';
        }
      };

      const attachLineListeners = (div, type) => {
        const select = div.querySelector(type === 'product' ? 'select[name="product_id"]' : 'select[name="service_id"]');
        const priceInput = div.querySelector('input[name="prix"]');
        if (select) {
          select.addEventListener('change', () => {
            const item = this.findItem(select.value);
            if (item && priceInput && (!priceInput.value || Number(priceInput.value) === 0)) {
              priceInput.value = type === 'product' ? (item.prix_vente || 0) : (item.tarif_service || 0);
            }
            evaluatePrices();
          });
        }
        if (priceInput) priceInput.addEventListener('input', () => evaluatePrices());
      };

      const addProduct = () => {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-1 md:grid-cols-4 gap-3';
        div.dataset.saleLine = 'product';
        div.innerHTML = `
          <select name="product_id" class="bg-slate-900 border border-slate-700 rounded px-3 py-2">
            <option value="">-- Produit --</option>
            ${this.data.items.filter(i => i.type === 'product').map(item => `<option value="${item.item_id}">${item.nom}</option>`).join('')}
          </select>
          <input name="qty" type="number" min="1" value="1" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" />
          <input name="prix" type="number" min="0" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Prix" />
          <button type="button" class="text-xs text-rose-300" data-remove-line>Supprimer</button>
        `;
        productContainer.appendChild(div);
        attachLineListeners(div, 'product');
        evaluatePrices();
      };

      const addService = () => {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-1 md:grid-cols-4 gap-3';
        div.dataset.saleLine = 'service';
        div.innerHTML = `
          <select name="service_id" class="bg-slate-900 border border-slate-700 rounded px-3 py-2">
            <option value="">-- Service --</option>
            ${this.data.items.filter(i => i.type === 'service').map(item => `<option value="${item.item_id}">${item.nom}</option>`).join('')}
          </select>
          <input name="qty" type="number" min="1" value="1" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" />
          <input name="prix" type="number" min="0" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Prix" />
          <button type="button" class="text-xs text-rose-300" data-remove-line>Supprimer</button>
        `;
        serviceContainer.appendChild(div);
        attachLineListeners(div, 'service');
        evaluatePrices();
      };

      addProduct();
      document.getElementById('add-sale-product').addEventListener('click', () => addProduct());
      document.getElementById('add-sale-service').addEventListener('click', () => addService());
      productContainer.addEventListener('click', (e) => {
        if (e.target.matches('[data-remove-line]')) {
          e.target.parentElement.remove();
          evaluatePrices();
        }
      });
      serviceContainer.addEventListener('click', (e) => {
        if (e.target.matches('[data-remove-line]')) {
          e.target.parentElement.remove();
          evaluatePrices();
        }
      });
      evaluatePrices();
    },

    async handleNewSale(form) {
      const formData = new FormData(form);
      const client_id = formData.get('client_id');
      if (!client_id) {
        alert('Client obligatoire');
        return;
      }
      const lines = [];
      let hasLowPrice = false;
      document.querySelectorAll('#sale-product-lines > div').forEach(div => {
        const product_id = div.querySelector('select[name="product_id"]').value;
        const qty = Number(div.querySelector('input[name="qty"]').value || 0);
        let prix = Number(div.querySelector('input[name="prix"]').value || 0);
        if (product_id && qty > 0) {
          const item = this.findItem(product_id);
          if (!prix) prix = item?.prix_vente || 0;
          const base = item?.prix_vente || 0;
          if (base > 0 && prix < base) hasLowPrice = true;
          lines.push({ type: 'product', item_id: product_id, qty, pu: prix, tva: 0 });
        }
      });
      document.querySelectorAll('#sale-service-lines > div').forEach(div => {
        const service_id = div.querySelector('select[name="service_id"]').value;
        const qty = Number(div.querySelector('input[name="qty"]').value || 0);
        let prix = Number(div.querySelector('input[name="prix"]').value || 0);
        if (service_id && qty > 0) {
          const item = this.findItem(service_id);
          if (!prix) prix = item?.tarif_service || 0;
          const base = item?.tarif_service || 0;
          if (base > 0 && prix < base) hasLowPrice = true;
          lines.push({ type: 'service', item_id: service_id, qty, pu: prix, tva: 0 });
        }
      });
      if (lines.length === 0) {
        alert('Ajouter au moins une ligne.');
        return;
      }
      const motifPrix = (formData.get('motif_prix') || '').trim();
      if (hasLowPrice) {
        if (!this.isManager()) {
          alert('Prix inférieur au tarif standard – validation manager requise.');
          return;
        }
        if (!motifPrix) {
          alert('Motif manager obligatoire pour valider ce prix.');
          return;
        }
      }
      const remise = Number(formData.get('remise') || 0);
      const totalBrut = lines.reduce((sum, l) => sum + l.qty * l.pu, 0);
      const total = Math.max(0, totalBrut - totalBrut * (remise / 100));
      const invoice = {
        id: this.nextInvoiceId(),
        type: formData.get('type'),
        site: this.data.currentSite,
        client_id,
        lignes: lines,
        total,
        payes: [],
        reste: total,
        statut: 'non_payee',
        created_at: this.todayISO()
      };
      if (hasLowPrice && motifPrix) invoice.motif_prix = motifPrix;
      const montant_paye = Number(formData.get('montant_paye') || 0);
      if (montant_paye > 0) {
        invoice.payes.push({ montant: montant_paye, moyen: formData.get('moyen'), date: this.todayISO() });
        invoice.reste = Math.max(0, invoice.total - montant_paye);
        invoice.statut = invoice.reste === 0 ? 'payee' : 'partielle';
      }
      if (invoice.reste > 0) {
        if (!formData.get('echeance')) {
          alert('Échéance obligatoire si reste à payer.');
          return;
        }
        invoice.echeance = formData.get('echeance');
        const creance = {
          id: this.nextId('CR', this.data.creances),
          categorie: 'client',
          reference_id: client_id,
          libelle: `Facture ${invoice.id}`,
          montant: invoice.total,
          reste: invoice.reste,
          echeance: invoice.echeance,
          statut: invoice.statut === 'payee' ? 'solde' : (invoice.statut === 'partielle' ? 'partiel' : 'ouvert'),
          paiements: invoice.payes.slice(),
          type: 'client',
          site: invoice.site
        };
        this.addCreance(creance);
        invoice.creance_id = creance.id;
      }
      this.data.invoices.push(invoice);
      this.decrementStockForInvoice(invoice);
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Facture enregistrée.');
      this.openPrintableInvoice(invoice);
    },

    modalPayInvoice(id) {
      const invoice = this.data.invoices.find(inv => inv.id === id);
      if (!invoice) return '';
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Paiement ${invoice.id}</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form data-pay-invoice="${invoice.id}" class="px-6 py-6 space-y-4 text-sm">
              <p>Total ${this.formatGNF(invoice.total)} – Reste ${this.formatGNF(invoice.reste)}</p>
              <div>
                <label class="block mb-1 text-slate-400">Montant</label>
                <input name="montant" type="number" min="0" value="${invoice.reste}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Moyen</label>
                <select name="moyen" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                  <option value="cash">Cash</option>
                  <option value="mobile_money">Mobile money</option>
                </select>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white">Valider</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handlePayInvoice(form) {
      const id = form.dataset.payInvoice;
      const invoice = this.data.invoices.find(inv => inv.id === id);
      if (!invoice) return;
      const formData = new FormData(form);
      const montant = Number(formData.get('montant') || 0);
      if (montant <= 0) return alert('Montant invalide');
      this.registerInvoicePayment(invoice, { montant, moyen: formData.get('moyen'), date: this.todayISO() });
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Paiement enregistré.');
    },

    /* ------------------------------ WORK ORDERS ------------------------------ */
    renderWorkOrders() {
      return `
        <div class="p-8 space-y-6">
          <div class="flex justify-between items-center">
            <h2 class="text-lg font-semibold">Bons de réparation</h2>
            ${this.canCommercialActions() ? '<button class="btn-primary" data-open="new-wo"><i data-lucide="clipboard-plus" class="w-4 h-4"></i> Nouveau dépôt</button>' : ''}
          </div>
          <div class="bg-slate-900/60 border border-slate-800 rounded-xl overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-900/70 text-xs text-slate-400 uppercase">
                <tr>
                  <th class="px-4 py-3 text-left">WO</th>
                  <th class="px-4 py-3 text-left">Client</th>
                  <th class="px-4 py-3 text-left">Appareil</th>
                  <th class="px-4 py-3 text-left">Site</th>
                  <th class="px-4 py-3 text-left">Statut</th>
                  <th class="px-4 py-3 text-left">Dates clés</th>
                  <th class="px-4 py-3 text-left">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800">
                ${this.data.work_orders.slice().reverse().map(wo => {
                  const client = this.data.clients.find(c => c.id === wo.client_id);
                  const device = this.data.devices.find(d => d.id === wo.device_id);
                  const actions = this.renderWOActions(wo);
                  return `<tr class="hover:bg-slate-900/40">
                    <td class="px-4 py-3">${wo.id}</td>
                    <td class="px-4 py-3">${client?.nom || wo.client_id}</td>
                    <td class="px-4 py-3 text-xs text-slate-400">${device?.marque || ''} ${device?.modele || ''}</td>
                    <td class="px-4 py-3">${wo.site}</td>
                    <td class="px-4 py-3"><span class="text-xs px-3 py-1 rounded-full bg-indigo-500/20 text-indigo-200">${wo.statut.replace(/_/g,' ')}</span></td>
                    <td class="px-4 py-3 text-xs text-slate-400">
                      Dépôt: ${wo.dates?.depot || '—'}<br/>
                      Diagnostic: ${wo.dates?.diagnostic || '—'}<br/>
                      Livraison: ${wo.dates?.livraison || '—'}
                    </td>
                    <td class="px-4 py-3 space-x-2">${actions}</td>
                  </tr>`;
                }).join('') || '<tr><td colspan="7" class="px-4 py-4 text-center text-sm text-slate-400">Aucun WO.</td></tr>'}
              </tbody>
            </table>
          </div>
        </div>
      `;
    },

    renderWOActions(wo) {
      const buttons = [];
      if (this.canTechnicianActions() && wo.statut === 'diagnostic') {
        buttons.push(`<button class="text-xs text-indigo-300" data-wo-update="${wo.id}">Saisir diagnostic</button>`);
      }
      if (this.canCommercialActions() && wo.statut === 'attente_confirmation') {
        buttons.push(`<button class="text-xs text-emerald-300" data-wo-update="${wo.id}">Valider / Rejeter</button>`);
      }
      if (this.canTechnicianActions() && wo.statut === 'en_cours_reparation') {
        buttons.push(`<button class="text-xs text-indigo-300" data-wo-update="${wo.id}">Terminer réparation</button>`);
      }
      if (this.canCommercialActions() && wo.statut === 'termine_tech') {
        buttons.push(`<button class="text-xs text-amber-300" data-wo-checklist="${wo.id}">Checklist sortie</button>`);
      }
      if (this.canCommercialActions() && wo.statut === 'checklist_ok') {
        buttons.push(`<button class="text-xs text-sky-300" data-wo-ready="${wo.id}">Prêt retrait</button>`);
      }
      if (this.canCommercialActions() && wo.statut === 'pret_retrait') {
        buttons.push(`<button class="text-xs text-emerald-300" data-wo-delivery="${wo.id}">Livrer</button>`);
      }
      return buttons.join(' ');
    },

    bindWorkOrderEvents() {
      document.querySelectorAll('[data-open="new-wo"]').forEach(btn => btn.addEventListener('click', () => this.openModal('new-wo')));
      document.querySelectorAll('[data-wo-update]').forEach(btn => btn.addEventListener('click', () => this.openModal('update-wo', btn.dataset.woUpdate)));
      document.querySelectorAll('[data-wo-checklist]').forEach(btn => btn.addEventListener('click', () => this.openModal('wo-checklist', btn.dataset.woChecklist)));
      document.querySelectorAll('[data-wo-delivery]').forEach(btn => btn.addEventListener('click', () => this.openModal('wo-delivery', btn.dataset.woDelivery)));
      document.querySelectorAll('[data-wo-ready]').forEach(btn => btn.addEventListener('click', () => this.markWOReady(btn.dataset.woReady)));
    },

    bindNewWOModal() {
      const toggleClient = document.getElementById('wo-toggle-client');
      const clientSection = document.getElementById('wo-new-client');
      const clientSelect = document.getElementById('wo-client-select');
      const createClientBtn = document.getElementById('wo-create-client');
      if (toggleClient && clientSection) {
        toggleClient.addEventListener('click', () => clientSection.classList.toggle('hidden'));
      }
      if (createClientBtn) {
        createClientBtn.addEventListener('click', () => {
          const nom = clientSection.querySelector('input[name="client_nom"]').value.trim();
          if (!nom) { alert("Nom client requis"); return; }
          const payload = {
            nom,
            whatsapp: clientSection.querySelector('input[name="client_whatsapp"]').value,
            ville: clientSection.querySelector('input[name="client_ville"]').value,
            adresse: '',
            notes: clientSection.querySelector('textarea[name="client_notes"]').value
          };
          const client = this.createClientRecord(payload);
          this.saveData();
          const option = document.createElement('option');
          option.value = client.id;
          option.textContent = client.nom;
          clientSelect.appendChild(option);
          clientSelect.value = client.id;
          clientSection.classList.add('hidden');
          clientSection.querySelectorAll('input,textarea').forEach(el => el.value = '');
          this.showToast('Client créé.');
        });
      }

      const toggleDevice = document.getElementById('wo-toggle-device');
      const deviceSection = document.getElementById('wo-new-device');
      const deviceSelect = document.getElementById('wo-device-select');
      const createDeviceBtn = document.getElementById('wo-create-device');
      if (toggleDevice && deviceSection) {
        toggleDevice.addEventListener('click', () => deviceSection.classList.toggle('hidden'));
      }
      if (createDeviceBtn) {
        createDeviceBtn.addEventListener('click', async () => {
          if (!clientSelect.value) { alert("Sélectionnez d'abord un client."); return; }
          const marque = deviceSection.querySelector('input[name="device_marque"]').value.trim();
          const modele = deviceSection.querySelector('input[name="device_modele"]').value.trim();
          if (!marque || !modele) { alert('Marque et modèle requis'); return; }
          const payload = {
            client_id: clientSelect.value,
            marque,
            modele,
            imei: deviceSection.querySelector('input[name="device_imei"]').value,
            imei_provisoire: deviceSection.querySelector('input[name="device_imei_provisoire"]').checked ? 'on' : '',
            code_deverrouillage: deviceSection.querySelector('input[name="device_code"]').value
          };
          const device = await this.createDeviceRecord(payload);
          this.saveData();
          const option = document.createElement('option');
          option.value = device.id;
          option.textContent = `${device.marque} ${device.modele}`;
          deviceSelect.appendChild(option);
          deviceSelect.value = device.id;
          deviceSection.classList.add('hidden');
          deviceSection.querySelectorAll('input').forEach(el => {
            if (el.type === 'checkbox') el.checked = false; else el.value = '';
          });
          this.showToast('Appareil créé.');
        });
      }
    },

    modalWorkOrder() {
      const clientOptions = this.data.clients.map(c => `<option value="${c.id}">${c.nom}</option>`).join('');
      const deviceOptions = this.data.devices.map(d => `<option value="${d.id}">${d.marque} ${d.modele}</option>`).join('');
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Nouveau dépôt réparation</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-new-wo" class="px-6 py-6 space-y-5 text-sm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <div class="flex items-center justify-between mb-1">
                    <label class="text-slate-400">Client</label>
                    <button type="button" id="wo-toggle-client" class="text-xs text-indigo-300">+ Nouveau client</button>
                  </div>
                  <select id="wo-client-select" name="client_id" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" required>
                    <option value="">-- Sélectionner --</option>
                    ${clientOptions}
                  </select>
                  <div id="wo-new-client" class="hidden mt-3 space-y-2 bg-slate-900/40 border border-slate-800 rounded-lg px-3 py-3">
                    <input name="client_nom" placeholder="Nom" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2" />
                    <input name="client_whatsapp" placeholder="WhatsApp" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2" />
                    <input name="client_ville" placeholder="Ville" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2" />
                    <textarea name="client_notes" placeholder="Notes" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2"></textarea>
                    <button type="button" id="wo-create-client" class="text-xs text-emerald-300">Enregistrer le client</button>
                  </div>
                </div>
                <div>
                  <div class="flex items-center justify-between mb-1">
                    <label class="text-slate-400">Appareil</label>
                    <button type="button" id="wo-toggle-device" class="text-xs text-indigo-300">+ Nouvel appareil</button>
                  </div>
                  <select id="wo-device-select" name="device_id" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" required>
                    <option value="">-- Sélectionner --</option>
                    ${deviceOptions}
                  </select>
                  <div id="wo-new-device" class="hidden mt-3 space-y-2 bg-slate-900/40 border border-slate-800 rounded-lg px-3 py-3">
                    <input name="device_marque" placeholder="Marque" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2" />
                    <input name="device_modele" placeholder="Modèle" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2" />
                    <input name="device_imei" placeholder="IMEI (peut être vide)" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2" />
                    <label class="flex items-center gap-2 text-xs text-slate-400"><input type="checkbox" name="device_imei_provisoire" class="bg-slate-900 border-slate-700" /> IMEI provisoire</label>
                    <input name="device_code" placeholder="Code déverrouillage" class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2" />
                    <button type="button" id="wo-create-device" class="text-xs text-emerald-300">Enregistrer l'appareil</button>
                  </div>
                </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block mb-1 text-slate-400">Site</label>
                  <select name="site" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                    ${SITES.map(site => `<option value="${site}" ${site === this.data.currentSite ? 'selected' : ''}>${site}</option>`).join('')}
                  </select>
                </div>
                <div class="md:col-span-2">
                  <label class="block mb-1 text-slate-400">Symptômes fréquents</label>
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    ${SYMPTOM_PRESETS.map(opt => `<label class="flex items-center gap-2 bg-slate-900/50 border border-slate-800 rounded px-3 py-2"><input type="checkbox" name="symptomes_presets" value="${opt.value}" class="bg-slate-900 border-slate-700"> <span>${opt.label}</span></label>`).join('')}
                  </div>
                </div>
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Autres symptômes</label>
                <textarea name="symptomes_libre" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Notes complémentaires"></textarea>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Créer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handleNewWO(form) {
      const formData = new FormData(form);
      const presetValues = Array.from(form.querySelectorAll('input[name="symptomes_presets"]:checked')).map(cb => cb.value);
      const presetLabels = presetValues.map(val => SYMPTOM_PRESETS.find(p => p.value === val)?.label || val);
      const libre = (formData.get('symptomes_libre') || '').split(/\n|,/).map(s => s.trim()).filter(Boolean);
      const symptomes = [...presetLabels, ...libre];
      const wo = {
        id: this.nextWOId(),
        client_id: formData.get('client_id'),
        device_id: formData.get('device_id'),
        site: formData.get('site'),
        technicien: null,
        symptomes,
        diagnostic: { texte: '', cout: 20000, revisions: [] },
        statut: 'diagnostic',
        lignes: [],
        checklist_test: {
          batterie: false,
          haut_parleur: false,
          ecran: false,
          charge: false,
          boutons: false,
          face_id: false,
          micro: false
        },
        acompte: { montant: 0, moyen: null, date: null },
        reste_a_payer: 0,
        journal: [],
        dates: { depot: this.todayISO().slice(0,10), diagnostic: null, validation_client: null, debut_rep: null, fin_rep: null, test: null, pret_retrait: null, livraison: null }
      };
      this.data.work_orders.push(wo);
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('WO créé.');
    },

    modalUpdateWO(id) {
      const wo = this.data.work_orders.find(w => w.id === id);
      if (!wo) return '';
      const isTechnician = this.canTechnicianActions();
      const isCommercial = this.canCommercialActions();
      const device = this.data.devices.find(d => d.id === wo.device_id);
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-3xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">${wo.id} – ${wo.statut.replace(/_/g,' ')}</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form data-update-wo="${wo.id}" class="px-6 py-6 space-y-4 text-sm">
              ${isTechnician && wo.statut === 'diagnostic' ? `
                <div>
                  <label class="block mb-1 text-slate-400">Diagnostic technicien</label>
                  <textarea name="diagnostic" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">${wo.diagnostic.texte || ''}</textarea>
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Coût proposé</label>
                  <input name="cout" type="number" min="0" value="${wo.diagnostic.cout || 20000}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Motif modification (si révision)</label>
                  <input name="motif" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                </div>
              ` : ''}
              ${isCommercial && wo.statut === 'attente_confirmation' ? `
                <div class="space-y-3">
                  <p class="text-sm text-slate-300">Diagnostic: ${wo.diagnostic.texte || ''}</p>
                  <p class="text-sm text-slate-300">Coût: ${this.formatGNF(wo.diagnostic.cout)}</p>
                  <label class="flex items-center gap-2"><input type="radio" name="decision" value="accepter" class="bg-slate-900 border-slate-700" checked> Accepter</label>
                  <label class="flex items-center gap-2"><input type="radio" name="decision" value="rejeter" class="bg-slate-900 border-slate-700"> Rejeter</label>
                  <div>
                    <label class="block mb-1 text-slate-400">Acompte (si acceptation)</label>
                    <input name="acompte" type="number" min="0" value="0" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
                  </div>
                  <div>
                    <label class="block mb-1 text-slate-400">Moyen acompte</label>
                    <select name="moyen" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                      <option value="cash">Cash</option>
                      <option value="mobile_money">Mobile money</option>
                    </select>
                  </div>
                </div>
              ` : ''}
              ${isTechnician && wo.statut === 'en_cours_reparation' ? `
                <div>
                  <label class="block mb-1 text-slate-400">Lignes réparation (services & pièces)</label>
                  <div id="wo-lines" class="space-y-3"></div>
                  <button type="button" id="wo-add-line" class="text-xs text-indigo-300">+ Ajouter ligne</button>
                </div>
                <div>
                  <label class="block mb-1 text-slate-400">Notes technicien</label>
                  <textarea name="notes" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2"></textarea>
                </div>
              ` : ''}
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    bindWOUpdateModal(id) {
      const wo = this.data.work_orders.find(w => w.id === id);
      if (!wo) return;
      if (this.canTechnicianActions() && wo.statut === 'en_cours_reparation') {
        const container = document.getElementById('wo-lines');
        const options = [
          ...this.data.items.filter(i => i.type === 'service').map(item => ({ value: `service|${item.item_id}`, label: `${item.nom} (Service)` })),
          ...this.data.items.filter(i => i.type === 'product' && i.categorie_article === 'Pièce').map(item => ({ value: `product|${item.item_id}`, label: `${item.nom} (Pièce)` }))
        ];
        const addLine = () => {
          const div = document.createElement('div');
          div.className = 'grid grid-cols-1 md:grid-cols-4 gap-3';
          div.innerHTML = `
            <select name="item_key" class="bg-slate-900 border border-slate-700 rounded px-3 py-2">
              ${options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
            </select>
            <input name="qty" type="number" min="1" value="1" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" />
            <input name="prix" type="number" min="0" class="bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="Prix" />
            <button type="button" class="text-xs text-rose-300" data-remove-line>Supprimer</button>
          `;
          container.appendChild(div);
        };
        addLine();
        document.getElementById('wo-add-line').addEventListener('click', () => addLine());
        container.addEventListener('click', (e) => {
          if (e.target.matches('[data-remove-line]')) e.target.parentElement.remove();
        });
      }
    },

    async handleUpdateWO(form) {
      const id = form.dataset.updateWo;
      const wo = this.data.work_orders.find(w => w.id === id);
      if (!wo) return;
      if (this.canTechnicianActions() && wo.statut === 'diagnostic') {
        const diagnostic = form.querySelector('textarea[name="diagnostic"]').value;
        const cout = Number(form.querySelector('input[name="cout"]').value || 0);
        const motif = (form.querySelector('input[name="motif"]').value || '').trim();
        const previous = wo.diagnostic.texte || '';
        if (previous && previous !== diagnostic && !motif) {
          alert('Motif obligatoire pour modifier le diagnostic.');
          return;
        }
        if (previous && previous !== diagnostic) {
          wo.diagnostic.revisions.push({ date: this.todayISO(), auteur: this.isManager() ? 'Manager' : this.getStaffRole(), motif, ancien_texte: previous });
        }
        wo.diagnostic.texte = diagnostic;
        wo.diagnostic.cout = cout;
        wo.statut = 'attente_confirmation';
        wo.dates.diagnostic = this.todayISO().slice(0,10);
      } else if (this.canCommercialActions() && wo.statut === 'attente_confirmation') {
        const decision = form.querySelector('input[name="decision"]:checked').value;
        if (decision === 'rejeter') {
          await this.finalizeRejectedWO(wo);
        } else {
          const acompte = Number(form.querySelector('input[name="acompte"]').value || 0);
          wo.statut = 'en_cours_reparation';
          wo.dates.validation_client = this.todayISO().slice(0,10);
          wo.dates.debut_rep = this.todayISO().slice(0,10);
          if (acompte > 0) {
            wo.acompte = { montant: acompte, moyen: form.querySelector('select[name="moyen"]').value, date: this.todayISO() };
          }
          wo.reste_a_payer = Math.max(0, wo.diagnostic.cout - (wo.acompte.montant || 0));
        }
      } else if (this.canTechnicianActions() && wo.statut === 'en_cours_reparation') {
        const lines = [];
        document.querySelectorAll('#wo-lines > div').forEach(div => {
          const key = div.querySelector('select[name="item_key"]').value;
          const [type, item_id] = key.split('|');
          const qty = Number(div.querySelector('input[name="qty"]').value || 0);
          let prix = Number(div.querySelector('input[name="prix"]').value || 0);
          if (item_id && qty > 0) {
            const item = this.findItem(item_id);
            if (!prix) prix = type === 'product' ? (item?.prix_vente || 0) : (item?.tarif_service || 0);
            lines.push({ type, item_id, qty, prix, tva: 0 });
          }
        });
        wo.lignes = lines;
        const notes = (form.querySelector('textarea[name="notes"]').value || '').trim();
        if (notes) {
          const auteur = this.isManager() ? 'Manager' : this.getStaffRole();
          wo.journal.push({ date: this.todayISO(), auteur, note: notes });
        }
        wo.statut = 'termine_tech';
        wo.dates.fin_rep = this.todayISO().slice(0,10);
      }
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('WO mis à jour.');
    },

    async finalizeRejectedWO(wo) {
      const invoice = {
        id: this.nextInvoiceId(),
        type: 'reparation',
        site: wo.site,
        client_id: wo.client_id,
        wo_id: wo.id,
        lignes: [{ item_id: 'DIAG', type: 'service', qty: 1, pu: 20000, tva: 0 }],
        total: 20000,
        payes: [],
        reste: 20000,
        statut: 'non_payee',
        created_at: this.todayISO()
      };
      const echeance = prompt('Échéance pour la facture diagnostic (AAAA-MM-JJ) :', new Date().toISOString().slice(0,10));
      if (!echeance) {
        alert('Échéance obligatoire pour le diagnostic non réglé.');
        return;
      }
      invoice.echeance = echeance;
      const creance = {
        id: this.nextId('CR', this.data.creances),
        categorie: 'client',
        reference_id: wo.client_id,
        libelle: `Diagnostic ${wo.id}`,
        montant: invoice.total,
        reste: invoice.total,
        echeance,
        statut: 'ouvert',
        paiements: [],
        type: 'client',
        site: wo.site
      };
      this.addCreance(creance);
      invoice.creance_id = creance.id;
      this.data.invoices.push(invoice);
      wo.statut = 'rejete';
      wo.reste_a_payer = invoice.reste;
      wo.dates.livraison = this.todayISO().slice(0,10);
      this.openPrintableInvoice(invoice);
      this.showToast('Réparation rejetée – facture diagnostic créée.', 'warning');
    },

    modalWOChecklist(id) {
      const wo = this.data.work_orders.find(w => w.id === id);
      if (!wo) return '';
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Checklist ${wo.id}</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form data-wo-checklist="${wo.id}" class="px-6 py-6 space-y-3 text-sm">
              ${Object.keys(wo.checklist_test).map(key => `
                <label class="flex items-center gap-3">
                  <input type="checkbox" name="${key}" class="bg-slate-900 border-slate-700" ${wo.checklist_test[key] ? 'checked' : ''}>
                  <span class="capitalize">${key.replace(/_/g,' ')}</span>
                </label>`).join('')}
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Valider</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    handleWOChecklist(form) {
      const id = form.dataset.woChecklist;
      const wo = this.data.work_orders.find(w => w.id === id);
      if (!wo) return;
      Object.keys(wo.checklist_test).forEach(key => {
        wo.checklist_test[key] = form.querySelector(`input[name="${key}"]`).checked;
      });
      if (!Object.values(wo.checklist_test).every(Boolean)) {
        alert('Tous les tests doivent être validés.');
        return;
      }
      wo.statut = 'checklist_ok';
      wo.dates.test = this.todayISO().slice(0,10);
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Checklist validée.');
    },

    markWOReady(id) {
      const wo = this.data.work_orders.find(w => w.id === id);
      if (!wo) return;
      if (!Object.values(wo.checklist_test).every(Boolean)) {
        alert('Checklist incomplète.');
        return;
      }
      wo.statut = 'pret_retrait';
      wo.dates.pret_retrait = this.todayISO().slice(0,10);
      this.saveData();
      this.render();
      this.showToast('WO prêt pour retrait.');
    },

    openPrintableInvoice(invoice) {
      if (!invoice) return;
      try {
        const client = invoice.client_id ? this.data.clients.find(c => c.id === invoice.client_id) : null;
        const wo = invoice.wo_id ? this.data.work_orders.find(w => w.id === invoice.wo_id) : null;
        const lignesHtml = invoice.lignes.map(line => {
          const item = this.findItem(line.item_id);
          const label = item ? item.nom || item.categorie_service || item.item_id : line.item_id;
          return `<tr><td style="padding:4px 8px;border:1px solid #ccc;">${label}</td><td style="padding:4px 8px;border:1px solid #ccc;">${line.qty}</td><td style="padding:4px 8px;border:1px solid #ccc;">${this.formatGNF(line.pu)}</td><td style="padding:4px 8px;border:1px solid #ccc;">${this.formatGNF((line.qty || 1) * line.pu)}</td></tr>`;
        }).join('');
        const paymentsHtml = invoice.payes.map(p => `<li>${this.formatGNF(p.montant)} – ${p.moyen} (${p.date?.slice(0,10) || ''})</li>`).join('') || '<li>Aucun paiement enregistré</li>';
        const win = window.open('', '_blank');
        if (!win) { this.showToast('Aperçu impression bloqué.', 'warning'); return; }
        win.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>${invoice.id}</title></head><body style="font-family:Arial,sans-serif;padding:24px;">
          <h1 style="margin-bottom:0;">${invoice.id}</h1>
          <p style="margin-top:4px;color:#555;">Site : ${invoice.site || this.data.currentSite}</p>
          ${client ? `<p><strong>Client :</strong> ${client.nom}</p>` : ''}
          ${wo ? `<p><strong>WO :</strong> ${wo.id}</p>` : ''}
          <table style="border-collapse:collapse;width:100%;margin-top:16px;">
            <thead><tr><th style="padding:4px 8px;border:1px solid #ccc;text-align:left;">Ligne</th><th style="padding:4px 8px;border:1px solid #ccc;text-align:left;">Qté</th><th style="padding:4px 8px;border:1px solid #ccc;text-align:left;">PU</th><th style="padding:4px 8px;border:1px solid #ccc;text-align:left;">Montant</th></tr></thead>
            <tbody>${lignesHtml}</tbody>
          </table>
          <h3 style="margin-top:16px;">Paiements</h3>
          <ul>${paymentsHtml}</ul>
          <p><strong>Total :</strong> ${this.formatGNF(invoice.total)} – <strong>Reste :</strong> ${this.formatGNF(invoice.reste)}</p>
        </body></html>`);
        win.document.close();
        win.print();
      } catch (err) {
        console.error('Print error', err);
      }
    },

    modalWODelivery(id) {
      const wo = this.data.work_orders.find(w => w.id === id);
      if (!wo) return '';
      const device = this.data.devices.find(d => d.id === wo.device_id);
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Livraison ${wo.id}</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form data-wo-delivery="${wo.id}" class="px-6 py-6 space-y-4 text-sm">
              <p>IMEI actuel: ${device?.imei || '—'} ${device?.imei_provisoire ? '(provisoire)' : ''}</p>
              <div>
                <label class="block mb-1 text-slate-400">IMEI final</label>
                <input name="imei" value="${device?.imei || ''}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" ${device?.imei_provisoire ? '' : 'required'} />
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Montant à encaisser</label>
                <input name="montant" type="number" min="0" value="${wo.reste_a_payer || 0}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Moyen</label>
                <select name="moyen" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                  <option value="cash">Cash</option>
                  <option value="mobile_money">Mobile money</option>
                </select>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white">Livrer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handleWODelivery(form) {
      const id = form.dataset.woDelivery;
      const wo = this.data.work_orders.find(w => w.id === id);
      if (!wo) return;
      if (wo.statut !== 'pret_retrait') {
        alert('WO non prêt pour livraison.');
        return;
      }
      if (!Object.values(wo.checklist_test).every(Boolean)) {
        alert('Checklist non validée.');
        return;
      }
      const device = this.data.devices.find(d => d.id === wo.device_id);
      const imei = form.querySelector('input[name="imei"]').value;
      if (!imei) {
        alert('IMEI final obligatoire.');
        return;
      }
      if (device) {
        device.imei = imei;
        device.imei_provisoire = false;
      }
      const montant = Number(form.querySelector('input[name="montant"]').value || 0);
      wo.dates.livraison = this.todayISO().slice(0,10);
      wo.statut = 'livre';
      const lignes = [
        ...wo.lignes,
        ...this.bomForWO(wo)
      ];
      const invoice = {
        id: this.nextInvoiceId(),
        type: 'reparation',
        site: wo.site,
        client_id: wo.client_id,
        wo_id: wo.id,
        lignes: lignes.map(l => ({ item_id: l.item_id, type: l.type, qty: l.qty || 1, pu: l.prix || l.pu || 0, tva: 0 })),
        total: lignes.reduce((sum, l) => sum + (l.qty || 1) * (l.prix || l.pu || 0), 0),
        payes: [],
        reste: 0,
        statut: 'payee',
        created_at: this.todayISO()
      };
      if (wo.acompte.montant > 0) {
        invoice.payes.push({ montant: wo.acompte.montant, moyen: wo.acompte.moyen, date: wo.acompte.date });
      }
      if (montant > 0) {
        invoice.payes.push({ montant, moyen: form.querySelector('select[name="moyen"]').value, date: this.todayISO() });
      }
      const totalPayes = invoice.payes.reduce((sum, p) => sum + p.montant, 0);
      invoice.reste = Math.max(0, invoice.total - totalPayes);
      invoice.statut = invoice.reste === 0 ? 'payee' : (totalPayes > 0 ? 'partielle' : 'non_payee');
      if (invoice.reste > 0) {
        const echeance = prompt('Échéance pour le solde (AAAA-MM-JJ) :', new Date().toISOString().slice(0,10));
        if (!echeance) {
          alert('Échéance obligatoire.');
          return;
        }
        invoice.echeance = echeance;
        const creance = {
          id: this.nextId('CR', this.data.creances),
          categorie: 'client',
          reference_id: wo.client_id,
          libelle: `Solde réparation ${wo.id}`,
          montant: invoice.total,
          reste: invoice.reste,
          echeance,
          statut: invoice.statut === 'payee' ? 'solde' : (invoice.statut === 'partielle' ? 'partiel' : 'ouvert'),
          paiements: invoice.payes.slice(),
          type: 'client',
          site: wo.site
        };
        this.addCreance(creance);
        invoice.creance_id = creance.id;
      }
      this.data.invoices.push(invoice);
      this.decrementStockForInvoice(invoice);
      wo.reste_a_payer = invoice.reste;
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('WO livré et facturé.');
      this.openPrintableInvoice(invoice);
    },

    bomForWO(wo) {
      const services = wo.lignes.filter(l => l.type === 'service');
      const bomLines = [];
      services.forEach(line => {
        const bom = this.data.service_bom.filter(b => b.service_id === line.item_id);
        bom.forEach(b => {
          const item = this.findItem(b.product_id);
          if (item) bomLines.push({ type: 'product', item_id: item.item_id, qty: b.qty, prix: item.prix_vente });
        });
      });
      return bomLines;
    },

    /* ------------------------------ CREANCES ------------------------------ */
    renderCreances() {
      if (!this.state.subState.creanceTab) this.state.subState.creanceTab = 'clients';
      if (!this.state.subState.creanceSite) this.state.subState.creanceSite = 'all';
      if (!this.state.subState.creanceStatus) this.state.subState.creanceStatus = 'toutes';
      const tab = this.state.subState.creanceTab;
      const siteFilter = this.state.subState.creanceSite;
      const statusFilter = this.state.subState.creanceStatus;
      const now = new Date();
      const t = (key) => this.t(key);
      const statusButtons = [
        { id: 'toutes', label: t('creances.status.all') },
        { id: 'soldes', label: t('creances.status.closed') },
        { id: 'partielle', label: t('creances.status.partial') },
        { id: 'retard', label: t('creances.status.late') },
        { id: '10j', label: t('creances.status.soon10') }
      ];
      const isClientTab = tab === 'clients';
      const rows = this.data.creances
        .filter(creance => {
          const type = creance.type || 'client';
          if (tab === 'clients') return type === 'client' || type === 'interne';
          if (tab === 'fournisseurs') return type === 'fournisseur';
          return true;
        })
        .filter(creance => {
          if (siteFilter !== 'all') return (creance.site || this.data.currentSite) === siteFilter;
          return true;
        })
        .filter(creance => {
          const reste = Number(creance.reste || 0);
          const echeance = creance.echeance ? new Date(creance.echeance) : null;
          const diff = echeance ? (echeance - now) / (1000 * 60 * 60 * 24) : null;
          switch (statusFilter) {
            case 'soldes':
              return reste === 0;
            case 'partielle':
              return reste > 0 && (creance.statut === 'partiel' || (creance.paiements || []).length > 0);
            case 'retard':
              return reste > 0 && echeance && echeance < now;
            case '10j':
              return reste > 0 && diff !== null && diff >= 0 && diff <= 10;
            default:
              return true;
          }
        })
        .sort((a, b) => Number(b.reste || 0) - Number(a.reste || 0));
      const totalReste = rows.reduce((sum, c) => sum + Number(c.reste || 0), 0);
      return `
        <div class="p-8 space-y-6">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="inline-flex bg-slate-900/80 border border-slate-800 rounded-lg overflow-hidden">
              <button data-creance-tab="clients" class="px-4 py-2 text-sm ${isClientTab ? 'bg-indigo-500/20 text-indigo-200' : 'text-slate-300'}">${t('creances.tab.clients')}</button>
              <button data-creance-tab="fournisseurs" class="px-4 py-2 text-sm ${!isClientTab ? 'bg-indigo-500/20 text-indigo-200' : 'text-slate-300'}">${t('creances.tab.suppliers')}</button>
            </div>
            <div class="flex flex-wrap items-center gap-3 text-sm">
              <label class="flex items-center gap-2">
                <span>${t('creances.filter.site')}</span>
                <select data-creance-site class="bg-slate-900 border border-slate-700 rounded px-3 py-2">
                  <option value="all" ${siteFilter === 'all' ? 'selected' : ''}>${t('creances.status.all')}</option>
                  ${SITES.map(site => `<option value="${site}" ${siteFilter === site ? 'selected' : ''}>${site}</option>`).join('')}
                </select>
              </label>
              <div class="inline-flex bg-slate-900/80 border border-slate-800 rounded-lg overflow-hidden">
                ${statusButtons.map(btn => `<button data-creance-status="${btn.id}" class="px-3 py-2 ${statusFilter === btn.id ? 'bg-emerald-500/10 text-emerald-200' : 'text-slate-300'}">${btn.label}</button>`).join('')}
              </div>
            </div>
          </div>
          <div class="bg-slate-900/70 border border-slate-800 rounded-xl px-4 py-3 text-sm text-slate-300 flex items-center justify-between">
            <span>${rows.length} ${isClientTab ? t('creances.summary.clients') : t('creances.summary.suppliers')}</span>
            <span>${t('creances.summary.total')} : <strong class="text-indigo-200">${this.formatGNF(totalReste)}</strong></span>
          </div>
          <div class="bg-slate-900/60 border border-slate-800 rounded-xl overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-slate-900/70 text-xs text-slate-400 uppercase">
                <tr>
                  <th class="px-4 py-3 text-left">${t('creances.table.libelle')}</th>
                  <th class="px-4 py-3 text-left">${t('creances.table.site')}</th>
                  <th class="px-4 py-3 text-left">${t('creances.table.montant')}</th>
                  <th class="px-4 py-3 text-left">${t('creances.table.reste')}</th>
                  <th class="px-4 py-3 text-left">${t('creances.table.echeance')}</th>
                  <th class="px-4 py-3 text-left">${t('creances.table.statut')}</th>
                  <th class="px-4 py-3 text-left">${t('creances.table.actions')}</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-800">
                ${rows.map(creance => {
                  const reste = Number(creance.reste || 0);
                  const echeance = creance.echeance ? new Date(creance.echeance) : null;
                  const isLate = reste > 0 && echeance && echeance < now;
                  const diff = echeance ? (echeance - now) / (1000 * 60 * 60 * 24) : null;
                  const isSoon = reste > 0 && diff !== null && diff >= 0 && diff <= 10;
                  let label = t('creances.badge.open');
                  let cls = 'bg-indigo-500/20 text-indigo-200';
                  if (reste === 0) { label = t('creances.badge.closed'); cls = 'bg-emerald-500/20 text-emerald-200'; }
                  else if (isLate) { label = t('creances.badge.late'); cls = 'bg-rose-500/20 text-rose-200'; }
                  else if (isSoon) { label = t('creances.badge.soon'); cls = 'bg-amber-500/20 text-amber-200'; }
                  else if (creance.statut === 'partiel') { label = t('creances.badge.partial'); cls = 'bg-amber-500/20 text-amber-200'; }
                  return `<tr class="hover:bg-slate-900/40">
                    <td class="px-4 py-3">
                      <p class="font-medium text-slate-100">${creance.libelle}</p>
                      <p class="text-xs text-slate-400">${creance.categorie || creance.type || ''}</p>
                    </td>
                    <td class="px-4 py-3">${creance.site || '—'}</td>
                    <td class="px-4 py-3">${this.formatGNF(creance.montant)}</td>
                    <td class="px-4 py-3">${this.formatGNF(reste)}</td>
                    <td class="px-4 py-3">${creance.echeance || '—'}</td>
                    <td class="px-4 py-3"><span class="text-xs px-3 py-1 rounded-full ${cls}">${label}</span></td>
                    <td class="px-4 py-3">${reste > 0 ? `<button class="text-xs text-emerald-300" data-pay-creance="${creance.id}">${t('creances.action.pay')}</button>` : ''}</td>
                  </tr>`;
                }).join('') || `<tr><td colspan="7" class="px-4 py-4 text-center text-sm text-slate-400">${t('creances.empty')}</td></tr>`}
              </tbody>
            </table>
          </div>
        </div>
      `;
    },

    bindCreanceEvents() {
      document.querySelectorAll('[data-creance-tab]').forEach(btn => btn.addEventListener('click', () => {
        this.state.subState.creanceTab = btn.dataset.creanceTab;
        this.render();
      }));
      const siteSelect = document.querySelector('[data-creance-site]');
      if (siteSelect) {
        siteSelect.addEventListener('change', (e) => {
          this.state.subState.creanceSite = e.target.value;
          this.render();
        });
      }
      document.querySelectorAll('[data-creance-status]').forEach(btn => btn.addEventListener('click', () => {
        this.state.subState.creanceStatus = btn.dataset.creanceStatus;
        this.render();
      }));
      document.querySelectorAll('[data-pay-creance]').forEach(btn => btn.addEventListener('click', () => this.openModal('pay-creance', btn.dataset.payCreance)));
    },

    modalPayCreance(id) {
      const creance = this.data.creances.find(c => c.id === id);
      if (!creance) return '';
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Régler ${creance.libelle}</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form data-pay-creance="${creance.id}" class="px-6 py-6 space-y-4 text-sm">
              <p>Reste ${this.formatGNF(creance.reste)}</p>
              <div>
                <label class="block mb-1 text-slate-400">Montant</label>
                <input name="montant" type="number" min="0" value="${creance.reste}" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" />
              </div>
              <div>
                <label class="block mb-1 text-slate-400">Moyen</label>
                <select name="moyen" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2">
                  <option value="cash">Cash</option>
                  <option value="mobile_money">Mobile money</option>
                </select>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-emerald-600 text-white">Valider</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handlePayCreance(form) {
      const id = form.dataset.payCreance;
      const creance = this.data.creances.find(c => c.id === id);
      if (!creance) return;
      const formData = new FormData(form);
      const montant = Number(formData.get('montant') || 0);
      if (montant <= 0) return alert('Montant invalide');
      const paiement = { montant, moyen: formData.get('moyen'), date: this.todayISO() };
      creance.paiements.push(paiement);
      this.updateCreanceBalance(creance.id);
      const invoice = this.data.invoices.find(inv => inv.creance_id === creance.id);
      if (invoice) this.registerInvoicePayment(invoice, paiement);
      const purchase = this.data.purchases.find(p => p.creance_id === creance.id);
      if (purchase) {
        purchase.payes.push(paiement);
        purchase.reste = Math.max(0, purchase.reste - montant);
        purchase.statut = purchase.reste === 0 ? 'payee' : (purchase.reste < purchase.total ? 'partielle' : 'non_payee');
        if (purchase.reste <= 0) {
          purchase.reste = 0;
          purchase.echeance = null;
        }
      }
      this.saveData();
      this.closeModal();
      this.render();
      this.showToast('Créance mise à jour.');
    },

    /* ------------------------------ PARAMÈTRES ------------------------------ */
    renderSettings() {
      return `
        <div class="p-8 space-y-6">
          <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-6 space-y-4">
            <h2 class="text-lg font-semibold">Export / Import</h2>
            <div class="flex flex-wrap gap-3">
              <button id="btn-export" class="px-4 py-2 rounded bg-indigo-600 text-white">Exporter JSON</button>
              <button data-open="import" class="px-4 py-2 rounded bg-slate-800 text-slate-200 border border-slate-700">Importer JSON</button>
            </div>
          </div>
          <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-6">
            <h2 class="text-lg font-semibold">README</h2>
            <p class="text-sm text-slate-300 leading-relaxed">
              Simulation ERP Kada Gestion (front-only). Pour tester localement : double-cliquez sur <code>index.html</code> ou servez le fichier via n'importe quel serveur statique. La persistance se fait entièrement dans le navigateur via <code>localStorage</code> (clé <code>kada:data</code>). Utilisez les boutons d'export / import pour sauvegarder ou restaurer vos scénarios de démonstration.
            </p>
            <p class="text-sm text-slate-500 mt-4">// TODO: brancher l'import/export vers Google Drive dans Apps Script.</p>
          </div>
        </div>
      `;
    },

    bindSettingsEvents() {
      const exportBtn = document.getElementById('btn-export');
      if (exportBtn) exportBtn.addEventListener('click', () => this.exportData());
      document.querySelectorAll('[data-open="import"]').forEach(btn => btn.addEventListener('click', () => this.openModal('import-data')));
    },

    exportData() {
      const blob = new Blob([JSON.stringify(this.data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kada-data-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      this.showToast('Export JSON généré.');
    },

    modalImport() {
      return `
        <div class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
          <div class="bg-slate-950 border border-slate-800 rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-800">
              <h2 class="text-lg font-semibold">Importer des données</h2>
              <button data-close-modal class="text-slate-400 hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="form-import" class="px-6 py-6 space-y-4 text-sm">
              <div>
                <label class="block mb-1 text-slate-400">Collez le JSON exporté</label>
                <textarea name="json" rows="8" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2" placeholder="{...}"></textarea>
              </div>
              <div class="flex justify-end gap-3 pt-2">
                <button type="button" data-close-modal class="px-4 py-2 rounded border border-slate-700">Annuler</button>
                <button type="submit" class="px-4 py-2 rounded bg-indigo-600 text-white">Importer</button>
              </div>
            </form>
          </div>
        </div>
      `;
    },

    async handleImport(form) {
      try {
        const json = form.querySelector('textarea[name="json"]').value;
        const parsed = JSON.parse(json);
        this.data = Object.assign(structuredClone(seedData), parsed);
        this.saveData();
        this.closeModal();
        this.render();
        this.showToast('Import réussi.');
      } catch (err) {
        alert('JSON invalide.');
      }
    },

    /* ------------------------------ BIND FORMS ------------------------------ */
    bindViewForms() {
      const layer = document.getElementById('modal-layer');
      const form = layer.querySelector('form');
      if (!form) return;
      if (form.id === 'form-new-client') form.addEventListener('submit', (e) => { e.preventDefault(); this.handleNewClient(e.target); });
      if (form.id === 'form-new-device') form.addEventListener('submit', (e) => { e.preventDefault(); this.handleNewDevice(e.target); });
      if (form.id === 'form-new-supplier') form.addEventListener('submit', (e) => { e.preventDefault(); this.handleNewSupplier(e.target); });
      if (form.id === 'form-new-product') {
        this.bindNewProductModal();
        form.addEventListener('submit', (e) => { e.preventDefault(); this.handleNewProduct(e.target); });
      }
      if (form.id === 'form-new-service') form.addEventListener('submit', (e) => { e.preventDefault(); this.handleNewService(e.target); });
      if (form.id === 'form-stock-move') {
        this.bindStockMoveModal();
        form.addEventListener('submit', (e) => { e.preventDefault(); this.handleStockMove(e.target); });
      }
      if (form.id === 'form-transfer') form.addEventListener('submit', (e) => { e.preventDefault(); this.handleTransfer(e.target); });
      if (form.id === 'form-new-purchase') {
        this.bindPurchaseModal();
        form.addEventListener('submit', (e) => { e.preventDefault(); this.handleNewPurchase(e.target); });
      }
      if (form.dataset?.payPurchase) form.addEventListener('submit', (e) => { e.preventDefault(); this.handlePayPurchase(e.target); });
      if (form.id === 'form-new-sale') {
        this.bindSaleModal();
        form.addEventListener('submit', (e) => { e.preventDefault(); this.handleNewSale(e.target); });
      }
      if (form.dataset?.payInvoice) form.addEventListener('submit', (e) => { e.preventDefault(); this.handlePayInvoice(e.target); });
      if (form.id === 'form-new-wo') {
        this.bindNewWOModal();
        form.addEventListener('submit', (e) => { e.preventDefault(); this.handleNewWO(e.target); });
      }
      if (form.dataset?.updateWo) {
        this.bindWOUpdateModal(form.dataset.updateWo);
        form.addEventListener('submit', (e) => { e.preventDefault(); this.handleUpdateWO(e.target); });
      }
      if (form.dataset?.woChecklist) form.addEventListener('submit', (e) => { e.preventDefault(); this.handleWOChecklist(e.target); });
      if (form.dataset?.woDelivery) form.addEventListener('submit', (e) => { e.preventDefault(); this.handleWODelivery(e.target); });
      if (form.dataset?.payCreance) form.addEventListener('submit', (e) => { e.preventDefault(); this.handlePayCreance(e.target); });
      if (form.id === 'form-import') form.addEventListener('submit', (e) => { e.preventDefault(); this.handleImport(e.target); });
    },

    renderModalAndBind() {
      this.renderModal();
      this.bindViewForms();
    },

    /* ------------------------------ ENTRY POINT ------------------------------ */
    bindModalTriggers() {
      document.querySelectorAll('[data-open]').forEach(btn => btn.addEventListener('click', () => {
        const type = btn.dataset.open;
        if (type === 'import') this.openModal('import-data');
        else this.openModal(type);
        this.renderModalAndBind();
      }));
    },

    renderModal() {
      const layer = document.getElementById('modal-layer');
      if (!this.state.modal) { layer.innerHTML = ''; return; }
      const { type, payload } = this.state.modal;
      const modalHtml = {
        'new-client': () => this.modalClient(),
        'new-device': () => this.modalDevice(payload),
        'new-supplier': () => this.modalSupplier(),
        'new-product': () => this.modalProduct(),
        'new-service': () => this.modalService(),
        'new-stock-move': () => this.modalStockMove(),
        'new-transfer': () => this.modalTransfer(),
        'new-purchase': () => this.modalPurchase(),
        'pay-purchase': () => this.modalPayPurchase(payload),
        'new-sale': () => this.modalSale(),
        'pay-invoice': () => this.modalPayInvoice(payload),
        'new-wo': () => this.modalWorkOrder(),
        'update-wo': () => this.modalUpdateWO(payload),
        'wo-checklist': () => this.modalWOChecklist(payload),
        'wo-delivery': () => this.modalWODelivery(payload),
        'pay-creance': () => this.modalPayCreance(payload),
        'import-data': () => this.modalImport()
      }[type];
      layer.innerHTML = modalHtml ? modalHtml() : '';
      if (modalHtml) {
        layer.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => { this.closeModal(); }));
        layer.addEventListener('click', (e) => { if (e.target === layer.firstElementChild?.parentElement) this.closeModal(); });
        this.bindViewForms();
        lucide.createIcons();
      }
    },

    openModal(type, payload = null) {
      this.state.modal = { type, payload };
      this.renderModal();
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    KadaApp.init().then(() => {
      document.addEventListener('click', (e) => {
        if (e.target.matches('[data-open]')) {
          e.preventDefault();
        }
      });
    });
  });

  // Helpers CSS classes
  document.addEventListener('DOMContentLoaded', () => {
    const style = document.createElement('style');
    style.innerHTML = `
      .btn-primary { display:inline-flex; align-items:center; gap:0.5rem; background:#6366f1; color:white; padding:0.5rem 1rem; border-radius:9999px; font-size:0.875rem; }
      .btn-primary:hover { background:#818cf8; }
      .btn-secondary { display:inline-flex; align-items:center; gap:0.5rem; background:#1e293b; color:#cbd5f5; padding:0.5rem 1rem; border-radius:9999px; font-size:0.875rem; border:1px solid rgba(99,102,241,.4); }
      .btn-secondary:hover { background:#273449; }
    `;
    document.head.appendChild(style);
  });
  </script>
</body>
</html>
